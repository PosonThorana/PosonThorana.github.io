<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firebase Invoice App</title>
  <!-- Tailwind CSS for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
  <!-- jspdf library for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100">
  <div id="app" class="container mx-auto p-4">
    <!-- App will be rendered here dynamically -->
  </div>

  <script type="module">
    // Firebase SDK imports from CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables for Firebase services and app state
    let db;
    let auth;
    let userId = null;
    let appId;
    let currentPage = 'invoice'; // Set default page to invoice after login
    let userProfile = {}; // Store user profile data for the invoice PDF
    let clients = []; // Global array to store client data
    let projects = []; // Global array to store project data

    // Get Firebase configuration from the environment
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // A function to render the entire application
    const renderApp = (user) => {
      const appContainer = document.getElementById('app');
      appContainer.innerHTML = '';

      if (!user) {
        // Render the authentication section if no user is logged in
        renderAuthSection(appContainer);
      } else {
        // After login, render the main application and go to the invoice page
        currentPage = 'invoice';
        renderMainApp(appContainer);
      }
    };

    const renderMainApp = (container) => {
      // Main app structure with navigation bar
      container.innerHTML = `
        <div class="bg-gray-100 p-8 flex items-center justify-center min-h-screen">
          <div class="max-w-4xl w-full">
            <nav class="mb-8 flex space-x-4 flex-wrap">
              <button id="nav-invoice" class="px-4 py-2 rounded-lg font-semibold transition-colors bg-white text-gray-800">Create Invoice</button>
              <button id="nav-reports" class="px-4 py-2 rounded-lg font-semibold transition-colors bg-white text-gray-800">Reports</button>
              <button id="nav-clients" class="px-4 py-2 rounded-lg font-semibold transition-colors bg-white text-gray-800">Clients</button>
              <button id="nav-projects" class="px-4 py-2 rounded-lg font-semibold transition-colors bg-white text-gray-800">Project Templates</button>
              <button id="nav-profile" class="px-4 py-2 rounded-lg font-semibold transition-colors bg-white text-gray-800">Profile</button>
            </nav>
            <div id="content-area"></div>
          </div>
        </div>
      `;

      // Add event listeners for navigation buttons
      document.getElementById('nav-profile').addEventListener('click', () => { currentPage = 'profile'; renderContent(); });
      document.getElementById('nav-clients').addEventListener('click', () => { currentPage = 'clients'; renderContent(); });
      document.getElementById('nav-projects').addEventListener('click', () => { currentPage = 'projects'; renderContent(); });
      document.getElementById('nav-invoice').addEventListener('click', () => { currentPage = 'invoice'; renderContent(); });
      document.getElementById('nav-reports').addEventListener('click', () => { currentPage = 'reports'; renderContent(); });

      renderContent();
    };

    const renderContent = () => {
      const contentArea = document.getElementById('content-area');
      if (!contentArea) {
        console.error("Content area not found.");
        return;
      }

      // Update active navigation button styles
      document.querySelectorAll('nav button').forEach(button => {
        if (button.id === `nav-${currentPage}`) {
          button.classList.add('bg-indigo-600', 'text-white');
          button.classList.remove('bg-white', 'text-gray-800');
        } else {
          button.classList.remove('bg-indigo-600', 'text-white');
          button.classList.add('bg-white', 'text-gray-800');
        }
      });

      // Render the content for the current page
      switch (currentPage) {
        case 'profile':
          renderProfileSection(contentArea);
          break;
        case 'clients':
          renderClientsSection(contentArea);
          break;
        case 'projects':
          renderProjectsSection(contentArea);
          break;
        case 'invoice':
          renderInvoiceGenerator(contentArea);
          break;
        case 'reports':
          renderReportsSection(contentArea);
          break;
      }
    };

    // Render the authentication section
    const renderAuthSection = (container) => {
      container.innerHTML = `
        <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-200 w-full max-w-md mx-auto">
          <h1 class="text-3xl font-extrabold text-gray-900 text-center mb-6">Welcome to your Account</h1>
          <form id="auth-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">Email</label>
              <input type="email" id="auth-email" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Password</label>
              <input type="password" id="auth-password" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required />
            </div>
            <div id="auth-error" class="hidden p-3 bg-red-100 text-red-700 rounded-lg text-sm"></div>
            <div class="flex space-x-4">
              <button type="button" id="login-btn" class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">Log In</button>
              <button type="button" id="create-account-btn" class="w-full px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-300 transition-colors">Create Account</button>
            </div>
          </form>
        </div>
      `;

      // Add event listeners for auth buttons
      const emailInput = document.getElementById('auth-email');
      const passwordInput = document.getElementById('auth-password');
      const errorDiv = document.getElementById('auth-error');

      document.getElementById('login-btn').addEventListener('click', async () => {
        try {
          await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
        } catch (error) {
          errorDiv.textContent = error.message;
          errorDiv.classList.remove('hidden');
        }
      });

      document.getElementById('create-account-btn').addEventListener('click', async () => {
        try {
          await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
        } catch (error) {
          errorDiv.textContent = error.message;
          errorDiv.classList.remove('hidden');
        }
      });
    };

    // Render the Profile section
    const renderProfileSection = (container) => {
      container.innerHTML = `
        <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-200">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-extrabold text-gray-900">User Profile</h2>
          </div>
          <div class="mb-6 text-gray-600">
            <p class="text-sm font-medium">Your User ID:</p>
            <p id="user-id-display" class="font-mono break-all text-sm mt-1">${userId}</p>
          </div>
          <form id="profile-form" class="space-y-6">
            <div>
              <label class="block text-sm font-medium text-gray-700">Service Name</label>
              <input type="text" id="service-name" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm" required />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Payment Information</label>
              <textarea id="payment-info" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm" rows="4" placeholder="Add your bank account details or other payment methods here."></textarea>
            </div>
            <div id="profile-message" class="hidden p-3 rounded-lg text-sm"></div>
            <button type="submit" id="save-profile-btn" class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">Save Changes</button>
            <button type="button" id="signout-btn" class="w-full mt-4 px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-colors">Sign Out</button>
          </form>
        </div>
      `;

      // Set up the form with current user profile data
      const serviceNameInput = document.getElementById('service-name');
      const paymentInfoInput = document.getElementById('payment-info');
      serviceNameInput.value = userProfile.serviceName || '';
      paymentInfoInput.value = userProfile.paymentInfo || '';

      // Add event listener for the form submission
      document.getElementById('profile-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const serviceName = document.getElementById('service-name').value;
        const paymentInfo = document.getElementById('payment-info').value;
        const messageDiv = document.getElementById('profile-message');
        const saveBtn = document.getElementById('save-profile-btn');
        saveBtn.textContent = 'Saving...';
        saveBtn.disabled = true;

        try {
          await setDoc(doc(db, `artifacts/${appId}/users/${userId}/profile/info`), { serviceName, paymentInfo }, { merge: true });
          messageDiv.textContent = 'Profile updated successfully!';
          messageDiv.classList.add('bg-green-100', 'text-green-700');
          messageDiv.classList.remove('hidden', 'bg-red-100', 'text-red-700');
        } catch (error) {
          console.error("Error updating profile:", error);
          messageDiv.textContent = `Error updating profile: ${error.message}`;
          messageDiv.classList.add('bg-red-100', 'text-red-700');
          messageDiv.classList.remove('hidden', 'bg-green-100', 'text-green-700');
        } finally {
          saveBtn.textContent = 'Save Changes';
          saveBtn.disabled = false;
        }
      });
      
      // Add event listener for the sign out button
      document.getElementById('signout-btn').addEventListener('click', () => signOut(auth));
    };

    // Render the Clients section
    const renderClientsSection = (container) => {
      container.innerHTML = `
        <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-200">
          <h2 class="text-3xl font-extrabold text-gray-900 mb-6">Clients</h2>
          <form id="add-client-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">Client Name</label>
              <input type="text" id="client-name" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm" required />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Contact/Company</label>
              <input type="text" id="client-contact" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm" />
            </div>
            <div id="client-message" class="hidden p-3 rounded-lg text-sm"></div>
            <button type="submit" class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">Add Client</button>
          </form>
          <div class="mt-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Saved Clients</h3>
            <ul id="clients-list" class="divide-y divide-gray-200">
              <!-- Clients will be rendered here -->
            </ul>
          </div>
        </div>
      `;
      
      // Render the clients list from the global clients array
      const clientsList = document.getElementById('clients-list');
      if (clientsList) {
        clientsList.innerHTML = '';
        clients.forEach(client => {
          const li = document.createElement('li');
          li.className = 'py-4 flex justify-between items-center';
          li.innerHTML = `
            <div>
              <p class="font-semibold text-gray-900">${client.name}</p>
              <p class="text-sm text-gray-500">${client.contact}</p>
            </div>
            <div>
                <button class="px-4 py-2 text-sm bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-colors delete-client-btn" data-client-id="${client.id}">Delete</button>
            </div>
          `;
          clientsList.appendChild(li);
        });
      }

      // Add event listener for the form submission
      document.getElementById('add-client-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const clientName = document.getElementById('client-name').value;
        const clientContact = document.getElementById('client-contact').value;
        const messageDiv = document.getElementById('client-message');
        if (!clientName) {
          messageDiv.textContent = 'Client name cannot be empty.';
          messageDiv.classList.add('bg-red-100', 'text-red-700');
          messageDiv.classList.remove('hidden');
          return;
        }

        try {
          // Use clientName as the document ID
          await setDoc(doc(db, `artifacts/${appId}/users/${userId}/clients`, clientName), { name: clientName, contact: clientContact });
          messageDiv.textContent = 'Client added successfully!';
          messageDiv.classList.add('bg-green-100', 'text-green-700');
          messageDiv.classList.remove('hidden', 'bg-red-100', 'text-red-700');
          document.getElementById('add-client-form').reset();
        } catch (error) {
          console.error("Error adding client:", error);
          messageDiv.textContent = `Error adding client: ${error.message}`;
          messageDiv.classList.add('bg-red-100', 'text-red-700');
          messageDiv.classList.remove('hidden', 'bg-green-100', 'text-green-700');
        }
      });
      
      // Add event listener for delete buttons (using event delegation)
      document.getElementById('clients-list').addEventListener('click', async (e) => {
          if (e.target.classList.contains('delete-client-btn')) {
              const clientId = e.target.dataset.clientId;
              try {
                  await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/clients`, clientId));
              } catch (error) {
                  console.error("Error deleting client:", error);
              }
          }
      });
    };

    // Render the Projects section
    const renderProjectsSection = (container) => {
      container.innerHTML = `
        <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-200">
          <h2 class="text-3xl font-extrabold text-gray-900 mb-6">Project Templates</h2>
          <form id="add-project-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">Template Name</label>
              <input type="text" id="project-name" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm" required />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Description</label>
              <textarea id="project-description" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm" rows="2"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Price</label>
              <input type="number" id="project-price" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm" value="0" />
            </div>
            <div id="project-message" class="hidden p-3 rounded-lg text-sm"></div>
            <button type="submit" class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">Add Project Template</button>
          </form>
          <div class="mt-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Saved Templates</h3>
            <ul id="projects-list" class="divide-y divide-gray-200">
              <!-- Projects will be rendered here -->
            </ul>
          </div>
        </div>
      `;

      // Render the projects list from the global projects array
      const projectsList = document.getElementById('projects-list');
      if (projectsList) {
        projectsList.innerHTML = '';
        projects.forEach(project => {
          const li = document.createElement('li');
          li.className = 'py-4 flex justify-between items-center';
          li.innerHTML = `
            <div>
              <p class="font-semibold text-gray-900">${project.id}</p>
              <p class="text-sm text-gray-500">${project.description}</p>
              <p class="text-sm text-gray-500">Price: Rs${project.price.toFixed(2)}</p>
            </div>
            <div>
                <button class="px-4 py-2 text-sm bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-colors delete-project-btn" data-project-id="${project.id}">Delete</button>
            </div>
          `;
          projectsList.appendChild(li);
        });
      }

      // Add event listener for the form submission
      document.getElementById('add-project-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const projectName = document.getElementById('project-name').value;
        const projectDescription = document.getElementById('project-description').value;
        const projectPrice = parseFloat(document.getElementById('project-price').value) || 0;
        const messageDiv = document.getElementById('project-message');

        if (!projectName) {
          messageDiv.textContent = 'Project name cannot be empty.';
          messageDiv.classList.add('bg-red-100', 'text-red-700');
          messageDiv.classList.remove('hidden');
          return;
        }

        try {
          await setDoc(doc(db, `artifacts/${appId}/users/${userId}/projects`, projectName), {
            description: projectDescription,
            price: projectPrice
          });
          messageDiv.textContent = 'Project template added successfully!';
          messageDiv.classList.add('bg-green-100', 'text-green-700');
          messageDiv.classList.remove('hidden', 'bg-red-100', 'text-red-700');
          document.getElementById('add-project-form').reset();
        } catch (error) {
          console.error("Error adding project:", error);
          messageDiv.textContent = `Error adding project: ${error.message}`;
          messageDiv.classList.add('bg-red-100', 'text-red-700');
          messageDiv.classList.remove('hidden', 'bg-green-100', 'text-green-700');
        }
      });
      
      // Add event listener for delete buttons (using event delegation)
      document.getElementById('projects-list').addEventListener('click', async (e) => {
          if (e.target.classList.contains('delete-project-btn')) {
              const projectId = e.target.dataset.projectId;
              try {
                  await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/projects`, projectId));
              } catch (error) {
                  console.error("Error deleting project:", error);
              }
          }
      });
    };

    // Helper function to download an invoice as a PDF
    const downloadInvoiceAsPDF = (invoiceData, docId = null) => {
      // Check if jspdf library is available
      if (typeof window.jsPDF === 'undefined') {
        console.error("jsPDF library not loaded. Cannot download invoice.");
        return;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      let y = 20;

      // Header with service name and payment info from user profile
      doc.setFontSize(22);
      doc.text("INVOICE", 14, y);
      y += 10;
      doc.setFontSize(14);
      doc.text(`From: ${userProfile.serviceName || 'Your Service'}`, 14, y);
      y += 7;
      doc.setFontSize(12);
      doc.text(`Payment Info: ${userProfile.paymentInfo || 'N/A'}`, 14, y);
      y += 10;

      // Invoice metadata
      doc.setFontSize(12);
      doc.text(`Invoice # ${docId || new Date().getTime()}`, 140, 20);
      doc.text(`Creation Date: ${new Date().toLocaleDateString()}`, 140, 27);
      y = Math.max(y, 35); // Ensure a clean separation

      // Client information
      y += 10;
      doc.setFontSize(14);
      doc.text("Bill To:", 14, y);
      y += 7;
      doc.setFontSize(12);
      doc.text(`Client Name: ${invoiceData.client.name}`, 14, y);
      y += 7;
      doc.text(`Contact/Company: ${invoiceData.client.contact || 'N/A'}`, 14, y);
      y += 10;

      // Invoice Items Table Header
      doc.setFontSize(12);
      doc.setFont("helvetica", "bold");
      doc.text("Description", 14, y);
      doc.text("Qty", 100, y);
      doc.text("Price", 130, y);
      doc.text("Amount", 170, y);
      doc.line(14, y + 2, 196, y + 2); // Underline header
      y += 5;

      // Invoice Items Table Content
      doc.setFont("helvetica", "normal");
      const items = invoiceData.items;
      items.forEach(item => {
        y += 7;
        doc.text(item.description.substring(0, 50), 14, y); // Truncate description for space
        doc.text(item.quantity.toString(), 100, y);
        doc.text(`Rs${item.price.toFixed(2)}`, 130, y);
        doc.text(`Rs${(item.quantity * item.price).toFixed(2)}`, 170, y);
      });

      // Total
      y += 10;
      doc.line(14, y, 196, y); // Horizontal line before total
      y += 7;
      doc.setFontSize(14);
      doc.setFont("helvetica", "bold");
      doc.text("Total:", 130, y);
      doc.text(`Rs${invoiceData.total.toFixed(2)}`, 170, y);

      // Save the PDF
      doc.save(`invoice-${docId || new Date().toISOString().split('T')[0]}.pdf`);
    };

    // Render the Invoice Generator section
    const renderInvoiceGenerator = (container) => {
      let invoiceItems = [];

      container.innerHTML = `
        <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-200">
          <h2 class="text-3xl font-extrabold text-gray-900 mb-6">Invoice Generator</h2>
          <form id="invoice-form" class="space-y-6">
            <div>
              <label class="block text-sm font-medium text-gray-700">Select Client</label>
              <select id="client-select" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm" required>
                <option value="">-- Select a saved client --</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Client Name</label>
              <input type="text" id="invoice-client-name" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm bg-gray-200" disabled />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Contact/Company</label>
              <input type="text" id="invoice-client-contact" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm bg-gray-200" disabled />
            </div>
            <div id="invoice-items-container" class="space-y-4">
              <h3 class="text-xl font-bold text-gray-800">Invoice Items</h3>
            </div>
            <button type="button" id="add-item-btn" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-300 transition-colors">Add Invoice Item</button>
            <div class="text-right">
              <h3 class="text-xl font-bold text-gray-800">Total: <span id="invoice-total">0.00</span></h3>
            </div>
            <div id="invoice-message" class="hidden p-3 rounded-lg text-sm"></div>
            <div class="flex space-x-4">
              <button type="submit" id="save-invoice-btn" class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">Save Invoice</button>
              <button type="button" id="download-invoice-btn" class="w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors">Download as PDF</button>
            </div>
          </form>
        </div>
      `;
      
      const updateInvoiceFormState = () => {
          const clientSelect = document.getElementById('client-select');
          const saveBtn = document.getElementById('save-invoice-btn');
          const downloadBtn = document.getElementById('download-invoice-btn');
          
          const isClientSelected = clientSelect.value !== '';
          const hasItems = invoiceItems.length > 0;
          
          if (isClientSelected && hasItems) {
              saveBtn.disabled = false;
              downloadBtn.disabled = false;
              saveBtn.classList.remove('bg-gray-400');
              downloadBtn.classList.remove('bg-gray-400');
              saveBtn.classList.add('bg-indigo-600');
              downloadBtn.classList.add('bg-green-600');
          } else {
              saveBtn.disabled = true;
              downloadBtn.disabled = true;
              saveBtn.classList.add('bg-gray-400');
              downloadBtn.classList.add('bg-gray-400');
              saveBtn.classList.remove('bg-indigo-600');
              downloadBtn.classList.remove('bg-green-600');
          }
      };


      const renderInvoiceItems = () => {
        const container = document.getElementById('invoice-items-container');
        if (!container) return; // Guard against null container
        container.innerHTML = `<h3 class="text-xl font-bold text-gray-800">Invoice Items</h3>`;
        invoiceItems.forEach((item, index) => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'p-4 border border-gray-200 rounded-lg grid grid-cols-5 gap-4 items-end';
          itemDiv.innerHTML = `
            <div>
              <label class="block text-sm font-medium text-gray-700">Template</label>
              <select class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm project-select" data-index="${index}">
                <option value="">-- Select template --</option>
                ${projects.map(p => `<option value="${p.id}" ${item.templateName === p.id ? 'selected' : ''}>${p.id}</option>`).join('')}
              </select>
            </div>
            <div class="col-span-2">
              <label class="block text-sm font-medium text-gray-700">Description</label>
              <textarea class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm item-description" rows="2" data-index="${index}">${item.description}</textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Quantity</label>
              <input type="number" value="${item.quantity}" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm item-quantity" data-index="${index}" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Price</label>
              <input type="number" value="${item.price}" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm item-price" data-index="${index}" />
            </div>
            <div class="col-span-1">
              <p class="text-sm font-medium text-gray-700">Amount</p>
              <p class="mt-1 font-bold text-gray-900">${(item.quantity * item.price).toFixed(2)}</p>
            </div>
          `;
          container.appendChild(itemDiv);
        });

        document.getElementById('invoice-total').textContent = invoiceItems.reduce((acc, item) => acc + (item.quantity * item.price), 0).toFixed(2);
        updateInvoiceFormState();

        // Add event listeners for the newly rendered items
        document.querySelectorAll('.project-select').forEach(select => {
            select.addEventListener('change', (e) => {
                const index = parseInt(e.target.dataset.index);
                const selectedProject = projects.find(p => p.id === e.target.value);
                if (selectedProject) {
                    invoiceItems[index].description = selectedProject.description;
                    invoiceItems[index].price = selectedProject.price;
                    invoiceItems[index].quantity = 1;
                    invoiceItems[index].templateName = selectedProject.id;
                } else {
                    invoiceItems[index].description = '';
                    invoiceItems[index].price = 0;
                    invoiceItems[index].templateName = '';
                    invoiceItems[index].quantity = 1;
                }
                renderInvoiceItems();
            });
        });
        document.querySelectorAll('.item-description').forEach(textarea => {
            textarea.addEventListener('input', (e) => {
                const index = parseInt(e.target.dataset.index);
                invoiceItems[index].description = e.target.value;
                renderInvoiceItems();
            });
        });
        document.querySelectorAll('.item-quantity').forEach(input => {
            input.addEventListener('input', (e) => {
                const index = parseInt(e.target.dataset.index);
                invoiceItems[index].quantity = parseFloat(e.target.value) || 0;
                renderInvoiceItems();
            });
        });
        document.querySelectorAll('.item-price').forEach(input => {
            input.addEventListener('input', (e) => {
                const index = parseInt(e.target.dataset.index);
                invoiceItems[index].price = parseFloat(e.target.value) || 0;
                renderInvoiceItems();
            });
        });
      };
      
      // Populate client dropdown
      const clientSelect = document.getElementById('client-select');
      if (clientSelect) {
        clientSelect.innerHTML = `<option value="">-- Select a saved client --</option>`;
        clients.forEach(client => {
          const option = document.createElement('option');
          option.value = client.id;
          option.textContent = client.name;
          clientSelect.appendChild(option);
        });
      }

      document.getElementById('client-select').addEventListener('change', (e) => {
        const selectedId = e.target.value;
        const clientNameInput = document.getElementById('invoice-client-name');
        const clientContactInput = document.getElementById('invoice-client-contact');
        if (selectedId) {
          const client = clients.find(c => c.id === selectedId);
          if (client) {
            clientNameInput.value = client.name;
            clientContactInput.value = client.contact;
          }
        } else {
            clientNameInput.value = '';
            clientContactInput.value = '';
        }
        updateInvoiceFormState();
      });
      
      document.getElementById('add-item-btn').addEventListener('click', () => {
          invoiceItems.push({ templateName: '', description: '', quantity: 1, price: 0, amount: 0 });
          renderInvoiceItems();
      });

      document.getElementById('invoice-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const clientSelect = document.getElementById('client-select');
        const clientName = document.getElementById('invoice-client-name').value;
        const clientContact = document.getElementById('invoice-client-contact').value;
        const messageDiv = document.getElementById('invoice-message');

        if (!clientName || invoiceItems.length === 0) {
            messageDiv.textContent = 'Please select a client and add at least one invoice item.';
            messageDiv.classList.add('bg-red-100', 'text-red-700');
            messageDiv.classList.remove('hidden');
            return;
        }

        try {
            const itemsToSave = invoiceItems.map(item => ({
                ...item,
                amount: item.quantity * item.price
            }));

            await addDoc(collection(db, `artifacts/${appId}/users/${userId}/invoices`), {
                client: { name: clientName, contact: clientContact },
                items: JSON.stringify(itemsToSave), // Use JSON.stringify to store the array of objects
                total: itemsToSave.reduce((acc, item) => acc + item.amount, 0),
                createdAt: serverTimestamp()
            });
            messageDiv.textContent = 'Invoice saved successfully!';
            messageDiv.classList.add('bg-green-100', 'text-green-700');
            messageDiv.classList.remove('hidden', 'bg-red-100', 'text-red-700');
            
            // Clear the form after submission
            document.getElementById('invoice-form').reset();
            invoiceItems = [];
            renderInvoiceItems();
        } catch (error) {
            console.error("Error saving invoice:", error);
            messageDiv.textContent = `Error saving invoice: ${error.message}`;
            messageDiv.classList.add('bg-red-100', 'text-red-700');
            messageDiv.classList.remove('hidden', 'bg-green-100', 'text-green-700');
        }
      });

      document.getElementById('download-invoice-btn').addEventListener('click', (e) => {
          const downloadBtn = e.target;
          // Disable the button to prevent multiple clicks
          downloadBtn.disabled = true;
          downloadBtn.textContent = 'Downloading...';

          const clientName = document.getElementById('invoice-client-name').value;
          const clientContact = document.getElementById('invoice-client-contact').value;
          const total = invoiceItems.reduce((acc, item) => acc + (item.quantity * item.price), 0);
          const messageDiv = document.getElementById('invoice-message');

          if (!clientName || invoiceItems.length === 0) {
              messageDiv.textContent = 'Please select a client and add at least one invoice item.';
              messageDiv.classList.add('bg-red-100', 'text-red-700');
              messageDiv.classList.remove('hidden');
              // Re-enable the button since there's an error
              downloadBtn.disabled = false;
              downloadBtn.textContent = 'Download as PDF';
              return;
          }

          const itemsForPDF = invoiceItems.map(item => ({
              ...item,
              amount: item.quantity * item.price
          }));

          const invoiceData = {
              client: { name: clientName, contact: clientContact },
              items: itemsForPDF,
              total: total
          };
          
          try {
            downloadInvoiceAsPDF(invoiceData);
            // Re-enable the button after a short delay for visual feedback
            setTimeout(() => {
                downloadBtn.disabled = false;
                downloadBtn.textContent = 'Download as PDF';
            }, 1000);
          } catch (error) {
              console.error("Error downloading invoice:", error);
              messageDiv.textContent = `Error downloading invoice: ${error.message}`;
              messageDiv.classList.add('bg-red-100', 'text-red-700');
              messageDiv.classList.remove('hidden', 'bg-green-100', 'text-green-700');
              // Re-enable the button on error
              downloadBtn.disabled = false;
              downloadBtn.textContent = 'Download as PDF';
          }
      });

      renderInvoiceItems(); // Initial render
    };

    // Render the Reports section (displaying invoices)
    const renderReportsSection = (container) => {
      container.innerHTML = `
        <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-200">
          <h2 class="text-3xl font-extrabold text-gray-900 mb-6">Invoices</h2>
          <div id="invoices-list" class="divide-y divide-gray-200">
            <p class="text-gray-500">Loading invoices...</p>
          </div>
        </div>
      `;

      const invoicesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/invoices`);
      onSnapshot(query(invoicesCollectionRef), (snapshot) => {
        const invoicesList = document.getElementById('invoices-list');
        if (!invoicesList) return; // Guard against null element
        invoicesList.innerHTML = '';
        if (snapshot.docs.length === 0) {
            invoicesList.innerHTML = `<p class="text-gray-500">No invoices saved yet.</p>`;
        } else {
            snapshot.docs.forEach(doc => {
                const invoice = doc.data();
                const items = JSON.parse(invoice.items);
                const li = document.createElement('li');
                li.className = 'py-4';
                li.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-semibold text-gray-900">${invoice.client.name}</p>
                            <p class="text-sm text-gray-500">${invoice.createdAt?.toDate().toLocaleDateString() || 'N/A'}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xl font-bold text-gray-900">Rs${invoice.total.toFixed(2)}</p>
                            <p class="text-sm text-gray-500">Invoice ID: ${doc.id}</p>
                        </div>
                    </div>
                    <div class="mt-4 text-sm text-gray-600">
                        <strong>Items:</strong>
                        <ul class="list-disc pl-5 mt-1">
                            ${items.map(item => `<li>${item.description} (Qty: ${item.quantity}, Price: Rs${item.price.toFixed(2)})</li>`).join('')}
                        </ul>
                    </div>
                    <div class="mt-4 text-right">
                      <button class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors download-saved-btn" data-doc-id="${doc.id}">Download</button>
                    </div>
                `;
                invoicesList.appendChild(li);
            });

            document.querySelectorAll('.download-saved-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const downloadBtn = e.target;
                    // Disable the button to prevent multiple clicks
                    downloadBtn.disabled = true;
                    downloadBtn.textContent = 'Downloading...';

                    const docId = e.target.dataset.docId;
                    const invoiceDoc = snapshot.docs.find(d => d.id === docId);
                    
                    try {
                        if (invoiceDoc) {
                            const invoiceData = invoiceDoc.data();
                            const items = JSON.parse(invoiceData.items);
                            downloadInvoiceAsPDF({ ...invoiceData, items }, docId);
                        }
                        // Re-enable the button after a short delay
                        setTimeout(() => {
                            downloadBtn.disabled = false;
                            downloadBtn.textContent = 'Download';
                        }, 1000);
                    } catch (error) {
                        console.error("Error downloading invoice:", error);
                        // Re-enable the button on error
                        downloadBtn.disabled = false;
                        downloadBtn.textContent = 'Download';
                    }
                });
            });
        }
      }, (error) => {
        console.error("Error listening to invoices:", error);
        const invoicesList = document.getElementById('invoices-list');
        if (invoicesList) invoicesList.innerHTML = `<p class="text-red-500">Error loading invoices.</p>`;
      });
    };

    // Initialize Firebase and set up the auth listener
    // All code is now inside the module scope to correctly access imports
    async function initializeAppAndRender() {
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Set up a listener for profile data
            onSnapshot(doc(db, `artifacts/${appId}/users/profile/info`), (docSnap) => {
              if (docSnap.exists()) {
                userProfile = docSnap.data();
              } else {
                userProfile = { serviceName: 'MEGA DESIGNS', paymentInfo: '' };
              }
              if (userId) renderContent();
            }, (error) => {
              console.error("Error listening to profile data:", error);
            });

            // Set up a listener for clients data
            const clientsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/clients`);
            onSnapshot(query(clientsCollectionRef), (snapshot) => {
              clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              if (userId) renderContent();
            }, (error) => console.error("Error listening to clients:", error));

            // Set up a listener for projects data
            const projectsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/projects`);
            onSnapshot(query(projectsCollectionRef), (snapshot) => {
              projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              if (userId) renderContent();
            }, (error) => console.error("Error listening to projects:", error));

            onAuthStateChanged(auth, async (user) => {
                userId = user ? user.uid : null;
                renderApp(user);
            });

            // Sign in with the custom token if available
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
        } catch (e) {
            console.error("Error initializing Firebase:", e);
        }
    }

    // Call the async function to start the app
    initializeAppAndRender();
  </script>
</body>
</html>
