import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, serverTimestamp } from 'firebase/firestore';
import { jsPDF } from 'jspdf';
import { BiPencil, BiTrash, BiDownload, BiPlus } from 'react-icons/bi';

const App = () => {
  // State for Firebase services and user data
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);

  // State for application data
  const [invoices, setInvoices] = useState([]);
  const [editingInvoiceId, setEditingInvoiceId] = useState(null);
  const [isLoading, setIsLoading] = useState(true);

  // State for the invoice form
  const [invoice, setInvoice] = useState({
    clientName: '',
    invoiceDate: '',
    dueDate: '',
    items: [{ description: '', quantity: 1, price: 0 }],
  });

  // Load external libraries and initialize Firebase
  useEffect(() => {
    const loadScripts = async () => {
      // Use dynamic import for jsPDF to avoid loading issues
      // This is a common pattern for client-side libraries
      try {
        await import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
      } catch (error) {
        console.error('Failed to load jsPDF script:', error);
        return;
      }
      
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

      // Initialize Firebase app and services
      const firebaseApp = initializeApp(firebaseConfig);
      const firestoreDb = getFirestore(firebaseApp);
      const firebaseAuth = getAuth(firebaseApp);

      setDb(firestoreDb);
      setAuth(firebaseAuth);

      // Authenticate the user with the provided token or anonymously
      const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
      if (token) {
        signInWithCustomToken(firebaseAuth, token)
          .catch((error) => console.error("Firebase custom auth failed:", error));
      } else {
        signInAnonymously(firebaseAuth)
          .catch((error) => console.error("Firebase anonymous auth failed:", error));
      }

      // Listen for auth state changes
      const unsubscribe = onAuthStateChanged(firebaseAuth, (user) => {
        if (user) {
          setUserId(user.uid);
        } else {
          setUserId(null);
        }
        setIsAuthReady(true);
      });

      return () => unsubscribe();
    };

    loadScripts();
  }, []);

  // Listen for real-time changes to the invoices collection
  useEffect(() => {
    if (!db || !isAuthReady || !userId) {
      // Return early if Firebase isn't ready or user is not authenticated
      if (isAuthReady) {
        setIsLoading(false);
      }
      return;
    }

    // Define the path to the public invoices collection
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const invoiceCollectionPath = `artifacts/${appId}/public/data/invoices`;
    const q = collection(db, invoiceCollectionPath);
    
    // Set up a real-time listener for the invoices
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const invoicesData = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data(),
        // Convert Firestore Timestamps to JavaScript Date objects
        createdAt: doc.data().createdAt?.toDate()
      }));
      setInvoices(invoicesData);
      setIsLoading(false);
    }, (error) => {
      console.error("Error fetching invoices:", error);
      setIsLoading(false);
    });

    return () => unsubscribe();
  }, [db, isAuthReady, userId]);

  // Handle input changes for the main invoice fields
  const handleInvoiceChange = (e) => {
    const { name, value } = e.target;
    setInvoice(prev => ({ ...prev, [name]: value }));
  };

  // Handle input changes for individual invoice items
  const handleItemChange = (index, e) => {
    const { name, value } = e.target;
    const newItems = [...invoice.items];
    newItems[index][name] = name === 'description' ? value : parseFloat(value) || 0;
    setInvoice(prev => ({ ...prev, items: newItems }));
  };

  // Add a new item to the invoice
  const handleAddItem = () => {
    setInvoice(prev => ({
      ...prev,
      items: [...prev.items, { description: '', quantity: 1, price: 0 }],
    }));
  };

  // Remove an item from the invoice
  const handleRemoveItem = (index) => {
    const newItems = invoice.items.filter((_, i) => i !== index);
    setInvoice(prev => ({ ...prev, items: newItems }));
  };

  // Calculate the total amount for the invoice
  const calculateTotal = () => {
    return invoice.items.reduce((total, item) => total + (item.quantity * item.price), 0);
  };

  // Save or update an invoice to Firestore
  const handleSave = async (e) => {
    e.preventDefault();
    if (!db || !userId) {
      console.error("Firestore not initialized or user not authenticated.");
      return;
    }
    
    // Create the invoice object to save
    const invoiceToSave = {
      ...invoice,
      total: calculateTotal(),
      // Add a timestamp for ordering and tracking
      createdAt: serverTimestamp(),
      // Track the user who created/edited the invoice
      authorId: userId,
    };
    
    // Use try/catch for error handling
    try {
      if (editingInvoiceId) {
        // Update an existing invoice
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const docRef = doc(db, `artifacts/${appId}/public/data/invoices`, editingInvoiceId);
        await setDoc(docRef, invoiceToSave, { merge: true });
        console.log("Invoice updated successfully!");
        setEditingInvoiceId(null);
      } else {
        // Add a new invoice
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const collectionRef = collection(db, `artifacts/${appId}/public/data/invoices`);
        await addDoc(collectionRef, invoiceToSave);
        console.log("Invoice saved successfully!");
      }

      // Reset the form after saving
      setInvoice({
        clientName: '',
        invoiceDate: '',
        dueDate: '',
        items: [{ description: '', quantity: 1, price: 0 }],
      });
    } catch (error) {
      console.error("Error saving invoice:", error);
    }
  };

  // Populate the form with data from the invoice to be edited
  const handleEdit = (invoiceToEdit) => {
    setInvoice(invoiceToEdit);
    setEditingInvoiceId(invoiceToEdit.id);
  };

  // Delete an invoice from Firestore
  const handleDelete = async (id) => {
    if (!db || !userId) return;
    try {
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const docRef = doc(db, `artifacts/${appId}/public/data/invoices`, id);
      await deleteDoc(docRef);
      console.log("Invoice deleted successfully!");
    } catch (error) {
      console.error("Error deleting invoice:", error);
    }
  };

  // Download an invoice as a PDF
  const handleDownload = (invoiceToDownload) => {
    // Check if the jsPDF library is loaded
    if (typeof jsPDF === 'undefined') {
      console.error("jsPDF is not loaded. Please check the script import.");
      return;
    }

    const doc = new jsPDF();
    let y = 10;
    const margin = 10;
    const padding = 5;

    // Add Invoice Title
    doc.setFontSize(22);
    doc.text('Invoice', margin, y);
    y += 10;

    // Add Client and Date Info
    doc.setFontSize(12);
    doc.text(`Client: ${invoiceToDownload.clientName}`, margin, y);
    y += 7;
    doc.text(`Invoice Date: ${invoiceToDownload.invoiceDate}`, margin, y);
    y += 7;
    doc.text(`Due Date: ${invoiceToDownload.dueDate}`, margin, y);
    y += 15;

    // Add Items Table Header
    doc.setFontSize(14);
    doc.text('Description', margin, y);
    doc.text('Quantity', 100, y);
    doc.text('Price', 140, y);
    doc.text('Amount', 180, y);
    y += 5;
    doc.line(margin, y, 200, y);
    y += 5;

    // Add Items to the table
    doc.setFontSize(12);
    invoiceToDownload.items.forEach(item => {
      const amount = item.quantity * item.price;
      doc.text(item.description, margin, y);
      doc.text(item.quantity.toString(), 100, y);
      doc.text(item.price.toString(), 140, y);
      doc.text(amount.toFixed(2), 180, y);
      y += 7;
    });

    y += 10;
    doc.setFontSize(16);
    doc.text(`Total: $${invoiceToDownload.total.toFixed(2)}`, 180, y, { align: 'right' });
    
    // Save the PDF with a dynamic filename
    doc.save(`invoice_${invoiceToDownload.clientName}.pdf`);
  };

  if (!isAuthReady || isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-100">
        <div className="text-xl font-semibold text-gray-700">Loading...</div>
      </div>
    );
  }

  return (
    <div className="flex flex-col min-h-screen bg-gray-100 font-inter text-gray-800">
      {/* Header and User ID Display */}
      <header className="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
        <h1 className="text-2xl font-bold text-gray-900">Invoice App</h1>
        <div className="bg-gray-200 text-sm p-2 rounded-md font-mono">
          <span className="font-semibold">User ID:</span> {userId}
        </div>
      </header>

      <main className="container mx-auto p-6 flex flex-col lg:flex-row gap-6">
        {/* Invoice Form Section */}
        <div className="lg:w-1/3 w-full bg-white rounded-xl shadow-lg p-6 h-fit">
          <h2 className="text-xl font-bold mb-6 text-gray-900">{editingInvoiceId ? 'Edit Invoice' : 'Create New Invoice'}</h2>
          <form onSubmit={handleSave} className="flex flex-col gap-4">
            {/* Invoice details */}
            <input
              type="text"
              name="clientName"
              value={invoice.clientName}
              onChange={handleInvoiceChange}
              placeholder="Client Name"
              required
              className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200"
            />
            <div className="flex gap-4">
              <input
                type="date"
                name="invoiceDate"
                value={invoice.invoiceDate}
                onChange={handleInvoiceChange}
                required
                className="w-1/2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200"
              />
              <input
                type="date"
                name="dueDate"
                value={invoice.dueDate}
                onChange={handleInvoiceChange}
                required
                className="w-1/2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200"
              />
            </div>
            
            {/* Invoice Items Section */}
            <div className="flex flex-col gap-2">
              <h3 className="text-lg font-semibold mt-4">Invoice Items</h3>
              {invoice.items.map((item, index) => (
                <div key={index} className="flex gap-2 items-center">
                  <input
                    type="text"
                    name="description"
                    value={item.description}
                    onChange={(e) => handleItemChange(index, e)}
                    placeholder="Description"
                    required
                    className="flex-grow p-3 border border-gray-300 rounded-lg"
                  />
                  <input
                    type="number"
                    name="quantity"
                    value={item.quantity}
                    onChange={(e) => handleItemChange(index, e)}
                    placeholder="Qty"
                    min="1"
                    className="w-16 p-3 border border-gray-300 rounded-lg text-center"
                  />
                  <input
                    type="number"
                    name="price"
                    value={item.price}
                    onChange={(e) => handleItemChange(index, e)}
                    placeholder="Price"
                    step="0.01"
                    className="w-24 p-3 border border-gray-300 rounded-lg text-center"
                  />
                  <button type="button" onClick={() => handleRemoveItem(index)} className="text-red-500 hover:text-red-700 transition duration-200">
                    <BiTrash size={20} />
                  </button>
                </div>
              ))}
              <button
                type="button"
                onClick={handleAddItem}
                className="mt-2 flex items-center justify-center gap-2 p-2 bg-blue-100 text-blue-600 font-medium rounded-lg hover:bg-blue-200 transition duration-200"
              >
                <BiPlus /> Add Item
              </button>
            </div>
            
            {/* Total Amount and Save Button */}
            <div className="mt-4 text-right">
              <span className="text-lg font-bold">Total: ${calculateTotal().toFixed(2)}</span>
            </div>
            <button
              type="submit"
              className="mt-6 w-full py-3 px-6 bg-blue-600 text-white font-bold text-lg rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300"
            >
              {editingInvoiceId ? 'Update Invoice' : 'Generate & Save'}
            </button>
          </form>
        </div>

        {/* Saved Invoices Section */}
        <div className="lg:w-2/3 w-full bg-white rounded-xl shadow-lg p-6">
          <h2 className="text-xl font-bold mb-6 text-gray-900">Saved Invoices</h2>
          <div className="grid gap-4">
            {invoices.length > 0 ? (
              invoices.map((inv) => (
                <div key={inv.id} className="flex justify-between items-center bg-gray-50 p-4 rounded-lg shadow-sm hover:shadow-md transition duration-200">
                  <div>
                    <h3 className="font-semibold text-lg">{inv.clientName}</h3>
                    <p className="text-gray-600 text-sm">Due: {inv.dueDate}</p>
                    <p className="text-gray-600 text-sm">Total: ${inv.total.toFixed(2)}</p>
                  </div>
                  <div className="flex gap-2">
                    <button onClick={() => handleEdit(inv)} className="p-2 text-blue-500 hover:text-blue-700 transition duration-200">
                      <BiPencil size={20} />
                    </button>
                    <button onClick={() => handleDelete(inv.id)} className="p-2 text-red-500 hover:text-red-700 transition duration-200">
                      <BiTrash size={20} />
                    </button>
                    <button onClick={() => handleDownload(inv)} className="p-2 text-green-500 hover:text-green-700 transition duration-200">
                      <BiDownload size={20} />
                    </button>
                  </div>
                </div>
              ))
            ) : (
              <p className="text-gray-500 text-center">No invoices saved yet.</p>
            )}
          </div>
        </div>
      </main>
    </div>
  );
};

export default App;
