<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Manager</title>
    <!-- Tailwind CSS CDN for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a clean, dark-themed look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text color */
        }
        .container {
            max-width: 1200px;
        }
        input[type="text"],
        input[type="number"],
        input[type="date"] {
            background-color: #2d3748; /* Dark input background */
            border-color: #4a5568; /* Darker border */
            color: #e2e8f0; /* Light text */
        }
        input:focus {
            outline: none;
            box-shadow: 0 0 0 2px #4299e1; /* Blue focus ring */
            border-color: #4299e1;
        }
        /* Style for the icon buttons to make them look uniform */
        .icon-button {
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon-button.edit {
            background-color: #4299e1; /* Blue background */
        }
        .icon-button.delete {
            background-color: #e53e3e; /* Red background */
        }
        .icon-button.download {
            background-color: #38a169; /* Green background */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Main content container -->
    <div id="app" class="container mx-auto p-6 flex flex-col lg:flex-row gap-6 flex-grow">

        <!-- Invoice Form Section -->
        <div class="lg:w-1/3 w-full bg-gray-800 rounded-xl shadow-lg p-6 h-fit border border-gray-700">
            <h2 id="form-title" class="text-xl font-bold mb-6 text-gray-200">Create New Invoice</h2>
            <form id="invoice-form" class="flex flex-col gap-4">
                <!-- Client Details -->
                <input type="text" id="clientName" placeholder="Client Name" required class="p-3 rounded-lg">
                <div class="flex gap-4">
                    <input type="date" id="invoiceDate" required class="w-1/2 p-3 rounded-lg">
                    <input type="date" id="dueDate" required class="w-1/2 p-3 rounded-lg">
                </div>

                <!-- Invoice Items Section -->
                <div class="flex flex-col gap-2 p-4 bg-gray-700 rounded-lg">
                    <h3 class="text-lg font-semibold mt-0">Invoice Items</h3>
                    <div id="items-container" class="flex flex-col gap-2">
                        <!-- Items will be dynamically added here -->
                    </div>
                    <button type="button" id="add-item-btn" class="mt-2 flex items-center justify-center gap-2 p-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                        Add Item
                    </button>
                </div>

                <!-- Total Amount and Save Button -->
                <div class="mt-4 text-right">
                    <span class="text-lg font-bold text-gray-200">Total: <span id="total-amount">$0.00</span></span>
                </div>
                <button type="submit" id="save-btn" class="mt-6 w-full py-3 px-6 bg-green-600 text-white font-bold text-lg rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-300">
                    Generate & Save
                </button>
            </form>
        </div>

        <!-- Saved Invoices Section -->
        <div class="lg:w-2/3 w-full bg-gray-800 rounded-xl shadow-lg p-6 border border-gray-700">
            <h2 class="text-xl font-bold mb-6 text-gray-200">Saved Invoices</h2>
            <div id="invoices-list" class="grid gap-4">
                <!-- Invoices will be dynamically rendered here -->
                <p id="no-invoices-message" class="text-gray-400 text-center">No invoices saved yet.</p>
            </div>
        </div>
    </div>
    
    <!-- Modal for confirmation -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
        <div id="modal-box" class="bg-gray-800 p-6 rounded-lg shadow-xl text-center">
            <p id="modal-text" class="text-lg mb-4">Are you sure?</p>
            <div class="flex justify-center gap-4">
                <button id="modal-confirm" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Yes</button>
                <button id="modal-cancel" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">No</button>
            </div>
        </div>
    </div>

    <!-- Firebase and jsPDF CDN scripts -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Initialization and Auth ---
        // Global variables for Firebase services
        let db;
        let auth;
        let userId;
        let appId;
        
        // Use a function to handle the entire app setup
        async function setupApp() {
            try {
                // Get pre-defined global variables from the environment
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                // Initialize Firebase services
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Sign in the user
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Listen for auth state changes and update UI
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // Start fetching data after successful authentication
                        setupRealtimeListener();
                    } else {
                        userId = null;
                        document.getElementById('invoices-list').innerHTML = '<p class="text-gray-400 text-center">Please sign in to view invoices.</p>';
                    }
                });
                
            } catch (error) {
                console.error("Error setting up Firebase:", error);
            }
        }

        // --- UI Element References ---
        const invoiceForm = document.getElementById('invoice-form');
        const itemsContainer = document.getElementById('items-container');
        const addItemBtn = document.getElementById('add-item-btn');
        const totalAmountSpan = document.getElementById('total-amount');
        const invoicesList = document.getElementById('invoices-list');
        const saveBtn = document.getElementById('save-btn');
        const formTitle = document.getElementById('form-title');
        const noInvoicesMessage = document.getElementById('no-invoices-message');
        
        let editingInvoiceId = null;

        // --- UI Logic and Handlers ---
        // Function to create a new item row in the form
        function createItemRow(description = '', quantity = 1, price = 0) {
            const itemRow = document.createElement('div');
            itemRow.className = 'flex gap-2 items-center';
            itemRow.innerHTML = `
                <input type="text" name="description" value="${description}" placeholder="Description" required class="flex-grow p-3 bg-gray-600 border border-gray-500 rounded-lg">
                <input type="number" name="quantity" value="${quantity}" placeholder="Qty" min="1" class="w-16 p-3 bg-gray-600 border border-gray-500 rounded-lg text-center">
                <input type="number" name="price" value="${price}" placeholder="Price" step="0.01" class="w-24 p-3 bg-gray-600 border border-gray-500 rounded-lg text-center">
                <button type="button" class="p-2 text-red-500 hover:text-red-400 transition duration-200 remove-item-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                </button>
            `;
            // Add a click listener for the remove button
            itemRow.querySelector('.remove-item-btn').addEventListener('click', () => {
                itemRow.remove();
                calculateTotal();
            });
            return itemRow;
        }

        // Add the initial item row
        itemsContainer.appendChild(createItemRow());

        // Event listener to add a new item row
        addItemBtn.addEventListener('click', () => {
            itemsContainer.appendChild(createItemRow());
            calculateTotal();
        });

        // Calculate the total amount and update the UI
        function calculateTotal() {
            let total = 0;
            const itemRows = itemsContainer.querySelectorAll('.flex-grow');
            itemRows.forEach(row => {
                const quantityInput = row.parentElement.querySelector('input[name="quantity"]');
                const priceInput = row.parentElement.querySelector('input[name="price"]');
                const quantity = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                total += quantity * price;
            });
            totalAmountSpan.textContent = `$${total.toFixed(2)}`;
        }
        
        // Listen for input changes to recalculate the total
        itemsContainer.addEventListener('input', calculateTotal);

        // --- Firestore Interaction Functions ---
        // Function to set up the real-time listener for invoices
        function setupRealtimeListener() {
            const invoiceCollectionPath = `artifacts/${appId}/public/data/invoices`;
            const q = collection(db, invoiceCollectionPath);
            
            onSnapshot(q, (snapshot) => {
                const invoices = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                }));
                renderInvoices(invoices);
            }, (error) => {
                console.error("Error fetching invoices:", error);
            });
        }

        // Function to render the list of invoices
        function renderInvoices(invoices) {
            invoicesList.innerHTML = ''; // Clear the list
            if (invoices.length === 0) {
                noInvoicesMessage.style.display = 'block';
                invoicesList.appendChild(noInvoicesMessage);
            } else {
                noInvoicesMessage.style.display = 'none';
                invoices.forEach(inv => {
                    const invoiceElement = document.createElement('div');
                    invoiceElement.className = 'flex flex-col sm:flex-row justify-between items-center bg-gray-700 p-4 rounded-lg shadow-sm transition duration-200 border border-gray-600';
                    
                    const invDate = inv.invoiceDate;
                    const dueDate = inv.dueDate;

                    invoiceElement.innerHTML = `
                        <div class="text-center sm:text-left mb-2 sm:mb-0">
                            <h3 class="font-semibold text-lg text-gray-100">${inv.clientName}</h3>
                            <p class="text-gray-400 text-sm">Due: ${dueDate}</p>
                            <p class="text-gray-300 text-lg font-bold">Total: $${inv.total.toFixed(2)}</p>
                        </div>
                        <div class="flex gap-2">
                            <button class="icon-button edit" data-id="${inv.id}" title="Edit">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
                            </button>
                            <button class="icon-button delete" data-id="${inv.id}" title="Delete">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                            </button>
                            <button class="icon-button download" data-id="${inv.id}" title="Download">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                            </button>
                        </div>
                    `;
                    invoicesList.appendChild(invoiceElement);
                });

                // Attach event listeners to the new buttons
                document.querySelectorAll('.edit').forEach(btn => {
                    btn.addEventListener('click', (e) => handleEdit(e.currentTarget.dataset.id));
                });
                document.querySelectorAll('.delete').forEach(btn => {
                    btn.addEventListener('click', (e) => handleDelete(e.currentTarget.dataset.id));
                });
                document.querySelectorAll('.download').forEach(btn => {
                    btn.addEventListener('click', (e) => handleDownload(e.currentTarget.dataset.id));
                });
            }
        }

        // Handle form submission (save/update)
        invoiceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!db || !userId) {
                console.error("Firebase not initialized or user not authenticated.");
                return;
            }
            
            // Collect form data
            const clientName = document.getElementById('clientName').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            const dueDate = document.getElementById('dueDate').value;
            const items = Array.from(itemsContainer.children).map(row => {
                const description = row.querySelector('input[name="description"]').value;
                const quantity = parseFloat(row.querySelector('input[name="quantity"]').value) || 0;
                const price = parseFloat(row.querySelector('input[name="price"]').value) || 0;
                return { description, quantity, price };
            });

            // Basic validation
            if (!clientName || !invoiceDate || !dueDate || items.length === 0 || items.some(item => !item.description || item.quantity <= 0 || item.price <= 0)) {
                // Using a custom modal instead of alert()
                showModal('Please fill in all required fields and ensure items have valid quantities and prices.');
                return;
            }

            const invoiceData = {
                clientName,
                invoiceDate,
                dueDate,
                items,
                total: parseFloat(totalAmountSpan.textContent.replace('$', '')),
                createdAt: serverTimestamp(),
                authorId: userId,
            };

            const invoiceCollectionPath = `artifacts/${appId}/public/data/invoices`;
            const collectionRef = collection(db, invoiceCollectionPath);

            try {
                if (editingInvoiceId) {
                    // Update existing invoice
                    const docRef = doc(db, collectionRef.path, editingInvoiceId);
                    await setDoc(docRef, invoiceData, { merge: true });
                    console.log("Invoice updated successfully!");
                } else {
                    // Add new invoice
                    await addDoc(collectionRef, invoiceData);
                    console.log("Invoice saved successfully!");
                }
                
                // Reset form
                invoiceForm.reset();
                itemsContainer.innerHTML = '';
                itemsContainer.appendChild(createItemRow());
                calculateTotal();
                editingInvoiceId = null;
                saveBtn.textContent = 'Generate & Save';
                formTitle.textContent = 'Create New Invoice';
            } catch (error) {
                console.error("Error saving invoice:", error);
            }
        });

        // Function to load an invoice into the form for editing
        async function handleEdit(id) {
            const docRef = doc(db, `artifacts/${appId}/public/data/invoices`, id);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const invoiceData = docSnap.data();
                    document.getElementById('clientName').value = invoiceData.clientName;
                    document.getElementById('invoiceDate').value = invoiceData.invoiceDate;
                    document.getElementById('dueDate').value = invoiceData.dueDate;

                    itemsContainer.innerHTML = ''; // Clear existing items
                    invoiceData.items.forEach(item => {
                        itemsContainer.appendChild(createItemRow(item.description, item.quantity, item.price));
                    });

                    calculateTotal();
                    editingInvoiceId = id;
                    saveBtn.textContent = 'Update Invoice';
                    formTitle.textContent = 'Edit Invoice';
                } else {
                    console.error("No such invoice found!");
                }
            } catch (error) {
                console.error("Error fetching invoice for editing:", error);
            }
        }
        
        // Function to delete an invoice with confirmation
        function handleDelete(id) {
            showModal('Are you sure you want to delete this invoice?', async () => {
                if (!db || !userId) return;
                try {
                    const docRef = doc(db, `artifacts/${appId}/public/data/invoices`, id);
                    await deleteDoc(docRef);
                    console.log("Invoice deleted successfully!");
                } catch (error) {
                    console.error("Error deleting invoice:", error);
                }
            });
        }
        
        // Function to download an invoice as a PDF
        async function handleDownload(id) {
            const docRef = doc(db, `artifacts/${appId}/public/data/invoices`, id);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const invoiceData = docSnap.data();
                    // Ensure jsPDF is loaded
                    if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                        console.error("jsPDF library not loaded.");
                        return;
                    }
                    const doc = new window.jspdf.jsPDF();
                    let y = 15;
                    const margin = 15;
                    const lineSpacing = 10;

                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(22);
                    doc.setTextColor(33, 33, 33);
                    doc.text('Invoice', margin, y);
                    y += lineSpacing * 1.5;

                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(12);
                    doc.text(`Client: ${invoiceData.clientName}`, margin, y);
                    y += lineSpacing;
                    doc.text(`Invoice Date: ${invoiceData.invoiceDate}`, margin, y);
                    y += lineSpacing;
                    doc.text(`Due Date: ${invoiceData.dueDate}`, margin, y);
                    y += lineSpacing * 1.5;

                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(14);
                    doc.text('Description', margin, y);
                    doc.text('Quantity', 100, y, { align: 'center' });
                    doc.text('Price', 140, y, { align: 'center' });
                    doc.text('Amount', 180, y, { align: 'right' });
                    y += lineSpacing * 0.5;
                    doc.line(margin, y, 195, y);
                    y += lineSpacing;

                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(12);
                    invoiceData.items.forEach(item => {
                        const amount = item.quantity * item.price;
                        doc.text(item.description, margin, y);
                        doc.text(item.quantity.toString(), 100, y, { align: 'center' });
                        doc.text(`$${item.price.toFixed(2)}`, 140, y, { align: 'center' });
                        doc.text(`$${amount.toFixed(2)}`, 180, y, { align: 'right' });
                        y += lineSpacing;
                    });

                    y += lineSpacing * 2;
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(16);
                    doc.text(`Total: $${invoiceData.total.toFixed(2)}`, 180, y, { align: 'right' });
                    
                    doc.save(`invoice_${invoiceData.clientName}.pdf`);
                }
            } catch (error) {
                console.error("Error downloading invoice:", error);
            }
        }
        
        // --- Custom Modal Functions (to replace alert/confirm) ---
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalText = document.getElementById('modal-text');
        const modalConfirmBtn = document.getElementById('modal-confirm');
        const modalCancelBtn = document.getElementById('modal-cancel');
        
        function showModal(message, onConfirm = null) {
            modalText.textContent = message;
            modalConfirmBtn.style.display = onConfirm ? 'inline-block' : 'none';
            modalCancelBtn.style.display = onConfirm ? 'inline-block' : 'none';
            modalBackdrop.classList.remove('hidden');
            modalBackdrop.classList.add('flex');

            return new Promise((resolve) => {
                const handleConfirm = () => {
                    resolve(true);
                    hideModal();
                    if (onConfirm) onConfirm();
                };
                const handleCancel = () => {
                    resolve(false);
                    hideModal();
                };

                modalConfirmBtn.onclick = handleConfirm;
                modalCancelBtn.onclick = handleCancel;
            });
        }
        
        function hideModal() {
            modalBackdrop.classList.remove('flex');
            modalBackdrop.classList.add('hidden');
            modalConfirmBtn.onclick = null;
            modalCancelBtn.onclick = null;
        }

        // --- Start the application ---
        window.onload = setupApp;
    </script>
</body>
</html>
