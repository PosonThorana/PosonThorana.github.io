<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Pro</title>
    <!-- Use Inter font -->
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .page-content {
            display: none;
        }
        .page-content.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-950 text-gray-900 dark:text-white">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.0/html-to-image.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Date Formatting -->
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.28.0/dist/date-fns.min.js"></script>
    <!-- Toast & Dialog Libraries (simplified inline versions) -->
    <style>
        .toast-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 1000;
        }
        .toast {
            background-color: #333;
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            max-width: 300px;
        }
        .toast.show {
            opacity: 1;
        }
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
        .dialog-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 90%;
        }
    </style>

    <!-- Main App Layout -->
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-50">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-blue-600">Invoice Pro</h1>
                <nav class="flex items-center space-x-4">
                    <button class="nav-button bg-blue-600 text-white font-semibold py-2 px-4 rounded-full hover:bg-blue-700 transition duration-300" data-page="dashboard">Dashboard</button>
                    <button class="nav-button bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition duration-300" data-page="clients">Clients</button>
                    <button class="nav-button bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition duration-300" data-page="projects">Projects</button>
                    <button class="nav-button bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition duration-300" data-page="reports">Reports</button>
                    <button class="nav-button bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition duration-300" data-page="profile">Profile</button>
                    <button id="sign-out-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-full hover:bg-red-600 transition duration-300">Sign Out</button>
                </nav>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 container mx-auto px-4 py-8">
            <!-- Dashboard Page -->
            <div id="dashboard-page" class="page-content active">
                <div class="p-8 space-y-8">
                    <h1 class="text-4xl font-bold">Create Invoice</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-white dark:bg-gray-800 shadow-md rounded-xl p-6 col-span-1 md:col-span-2">
                            <h2 class="text-2xl font-semibold mb-4">Invoice Details</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="invoice-number" class="block text-sm font-medium">Invoice #</label>
                                    <input type="text" id="invoice-number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" readonly>
                                </div>
                                <div>
                                    <label for="invoice-date" class="block text-sm font-medium">Invoice Date</label>
                                    <input type="date" id="invoice-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                </div>
                                <div>
                                    <label for="due-date" class="block text-sm font-medium">Due Date</label>
                                    <input type="date" id="due-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                </div>
                                <div>
                                    <label for="client-select" class="block text-sm font-medium">Client</label>
                                    <select id="client-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></select>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 shadow-md rounded-xl p-6 col-span-1 lg:col-span-1">
                            <h2 class="text-2xl font-semibold mb-4">Add Projects</h2>
                            <select id="project-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></select>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <h2 class="text-2xl font-bold">Invoice Items</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Description</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Rate</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Qty</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Unit</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Total</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"></th>
                                    </tr>
                                </thead>
                                <tbody id="invoice-items-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- Invoice items will be dynamically added here -->
                                </tbody>
                                <tfoot>
                                    <tr class="bg-white dark:bg-gray-800">
                                        <td colspan="4" class="px-6 py-3 text-right font-medium text-gray-500 dark:text-gray-300">Subtotal</td>
                                        <td id="subtotal-display" class="px-6 py-3 text-left font-semibold">$0.00</td>
                                        <td></td>
                                    </tr>
                                    <tr class="bg-white dark:bg-gray-800">
                                        <td colspan="4" class="px-6 py-3 text-right font-medium text-gray-500 dark:text-gray-300">
                                            <div class="flex items-center justify-end space-x-2">
                                                <span>Tax Rate (%)</span>
                                                <input type="number" id="tax-rate-input" value="0" class="w-20 rounded-md border-gray-300 p-1 text-gray-900">
                                            </div>
                                        </td>
                                        <td id="tax-display" class="px-6 py-3 text-left font-semibold">$0.00</td>
                                        <td></td>
                                    </tr>
                                    <tr class="bg-blue-600 text-white">
                                        <td colspan="4" class="px-6 py-3 text-right text-lg font-bold">Total</td>
                                        <td id="total-display" class="px-6 py-3 text-left text-lg font-bold">$0.00</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    <div class="flex justify-end gap-4 mt-8">
                        <button id="generate-invoice-btn" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-300">Generate & Save Invoice</button>
                        <button id="download-invoice-btn" class="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 transition duration-300">Download Invoice</button>
                    </div>
                </div>
            </div>

            <!-- Clients Page -->
            <div id="clients-page" class="page-content">
                <div class="p-8 space-y-8">
                    <div class="flex justify-between items-center">
                        <h1 class="text-4xl font-bold">My Clients</h1>
                        <button id="add-client-dialog-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-300">Add Client</button>
                    </div>
                    <div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-xl shadow-md p-4">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="clients-table-body" class="bg-white divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Clients will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Projects Page -->
            <div id="projects-page" class="page-content">
                <div class="p-8 space-y-8">
                    <div class="flex justify-between items-center">
                        <h1 class="text-4xl font-bold">My Projects/Services</h1>
                        <button id="add-project-dialog-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-300">Add Project</button>
                    </div>
                    <div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-xl shadow-md p-4">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rate</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="projects-table-body" class="bg-white divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Projects will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Page -->
            <div id="reports-page" class="page-content">
                <div class="p-8 space-y-8">
                    <h1 class="text-4xl font-bold">Monthly Reports</h1>
                    <div class="bg-white dark:bg-gray-800 shadow-md rounded-xl p-6">
                        <h2 class="text-2xl font-semibold mb-4">Generate Report</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="report-client-select" class="block text-sm font-medium">Select Client</label>
                                <select id="report-client-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></select>
                            </div>
                            <div>
                                <label for="report-start-date" class="block text-sm font-medium">Start Date</label>
                                <input type="date" id="report-start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                            <div>
                                <label for="report-end-date" class="block text-sm font-medium">End Date</label>
                                <input type="date" id="report-end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button id="download-report-btn" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-300">Download Report</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profile-page" class="page-content">
                <div class="p-8 space-y-8">
                    <h1 class="text-4xl font-bold">My Profile</h1>
                    <div class="bg-white dark:bg-gray-800 shadow-md rounded-xl p-6 space-y-4">
                        <h2 class="text-2xl font-semibold mb-4">Account Information</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="brand-name-input" class="block text-sm font-medium">Brand Name</label>
                                <input type="text" id="brand-name-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                            <div>
                                <label for="user-id-display" class="block text-sm font-medium">User ID</label>
                                <input type="text" id="user-id-display" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" readonly>
                            </div>
                        </div>
                        <h2 class="text-xl font-semibold mt-4">Contact Information</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="contact-name-input" class="block text-sm font-medium">Name</label>
                                <input type="text" id="contact-name-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                            <div>
                                <label for="contact-email-input" class="block text-sm font-medium">Email</label>
                                <input type="email" id="contact-email-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                            <div>
                                <label for="contact-phone-input" class="block text-sm font-medium">Phone</label>
                                <input type="tel" id="contact-phone-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                            <div>
                                <label for="contact-address-input" class="block text-sm font-medium">Address</label>
                                <input type="text" id="contact-address-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                        </div>
                        <h2 class="text-xl font-semibold mt-4">Payment Options</h2>
                        <div id="payment-options-container" class="space-y-2">
                            <!-- Payment options will be added here -->
                        </div>
                        <button id="add-payment-option-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 transition duration-300">Add Payment Option</button>
                        <div class="flex justify-end mt-4 gap-4">
                            <button id="save-profile-btn" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-300">Save Changes</button>
                            <button id="delete-profile-btn" class="px-6 py-3 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition duration-300">Delete Account</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Client Dialog Modal -->
    <div id="add-client-dialog" class="dialog-overlay">
        <div class="dialog-content">
            <h3 class="text-xl font-semibold mb-4">Add New Client</h3>
            <div class="space-y-4">
                <div>
                    <label for="new-client-name" class="block text-sm font-medium">Name</label>
                    <input type="text" id="new-client-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div>
                    <label for="new-client-email" class="block text-sm font-medium">Email</label>
                    <input type="email" id="new-client-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div>
                    <label for="new-client-address" class="block text-sm font-medium">Address</label>
                    <input type="text" id="new-client-address" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
            </div>
            <div class="flex justify-end mt-6 space-x-2">
                <button id="cancel-add-client-btn" class="px-4 py-2 bg-gray-200 rounded-lg font-semibold hover:bg-gray-300">Cancel</button>
                <button id="save-client-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">Save Client</button>
            </div>
        </div>
    </div>

    <!-- Project Dialog Modal -->
    <div id="add-project-dialog" class="dialog-overlay">
        <div class="dialog-content">
            <h3 class="text-xl font-semibold mb-4">Add New Project/Service</h3>
            <div class="space-y-4">
                <div>
                    <label for="new-project-name" class="block text-sm font-medium">Name</label>
                    <input type="text" id="new-project-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div>
                    <label for="new-project-description" class="block text-sm font-medium">Description</label>
                    <input type="text" id="new-project-description" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="new-project-rate" class="block text-sm font-medium">Rate</label>
                        <input type="number" id="new-project-rate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                    <div>
                        <label for="new-project-unit" class="block text-sm font-medium">Unit</label>
                        <input type="text" id="new-project-unit" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                </div>
            </div>
            <div class="flex justify-end mt-6 space-x-2">
                <button id="cancel-add-project-btn" class="px-4 py-2 bg-gray-200 rounded-lg font-semibold hover:bg-gray-300">Cancel</button>
                <button id="save-project-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">Save Project</button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Hidden element for PDF generation -->
    <div class="hidden">
        <div id="invoice-to-pdf" class="p-8 bg-white text-gray-800 rounded-lg shadow-xl max-w-4xl mx-auto">
            <header class="flex justify-between items-start mb-12 border-b-2 border-gray-200 pb-4">
                <div>
                    <h1 id="pdf-brand-name" class="text-4xl font-bold text-blue-600">Your Brand Name</h1>
                    <p id="pdf-brand-address" class="text-sm mt-1">Your address</p>
                    <p id="pdf-brand-email" class="text-sm">Your email</p>
                    <p id="pdf-brand-phone" class="text-sm">Your phone</p>
                </div>
                <div class="text-right">
                    <h2 class="text-2xl font-semibold text-gray-600">INVOICE</h2>
                    <p id="pdf-invoice-number" class="text-sm mt-1">Invoice #</p>
                    <p id="pdf-invoice-date" class="text-sm">Date:</p>
                    <p id="pdf-due-date" class="text-sm font-semibold text-red-500">Due:</p>
                </div>
            </header>

            <section class="flex justify-between items-start mb-12">
                <div>
                    <h3 class="font-bold text-lg text-gray-700 mb-2">BILL TO:</h3>
                    <p id="pdf-client-name" class="font-semibold"></p>
                    <p id="pdf-client-email" class="text-sm"></p>
                    <p id="pdf-client-address" class="text-sm"></p>
                </div>
            </section>

            <section class="mb-12">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">DESCRIPTION</th>
                            <th class="px-6 py-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider">RATE</th>
                            <th class="px-6 py-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider">QTY</th>
                            <th class="px-6 py-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider">TOTAL</th>
                        </tr>
                    </thead>
                    <tbody id="pdf-invoice-items" class="bg-white divide-y divide-gray-200">
                        <!-- Invoice items for PDF will go here -->
                    </tbody>
                </table>
            </section>

            <footer class="flex justify-end">
                <div class="w-full md:w-1/2">
                    <table class="w-full">
                        <tbody>
                            <tr>
                                <td class="font-semibold py-2">Subtotal</td>
                                <td id="pdf-subtotal" class="text-right py-2">$0.00</td>
                            </tr>
                            <tr>
                                <td class="font-semibold py-2">Tax (<span id="pdf-tax-rate">0</span>%)</td>
                                <td id="pdf-tax" class="text-right py-2">$0.00</td>
                            </tr>
                            <tr class="bg-blue-600 text-white font-bold text-lg">
                                <td class="py-2">Total Due</td>
                                <td id="pdf-total" class="text-right py-2">$0.00</td>
                            </tr>
                        </tbody>
                    </table>
                    <div id="pdf-payment-options-container" class="mt-6 p-4 bg-gray-100 rounded-lg">
                        <h4 class="font-bold mb-2">Payment Options:</h4>
                        <ul id="pdf-payment-options-list" class="list-disc list-inside text-sm">
                            <!-- Payment options for PDF will go here -->
                        </ul>
                    </div>
                </div>
            </footer>
        </div>
    </div>


    <script>
        // --- START: Firebase Configuration and Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyAdFr4gLREBC2K9G8GXzEBHpckCXax8M2A",
            authDomain: "invoice-genaraor.firebaseapp.com",
            projectId: "invoice-genaraor",
            storageBucket: "invoice-genaraor.firebasestorage.app",
            messagingSenderId: "691350547086",
            appId: "1:691350547086:web:6490d19dc93fa636ee77df",
            measurementId: "G-C2C7ELHC1F"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db, userId;
        let isAuthReady = false;

        async function initFirebase() {
            try {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();

                if (initialAuthToken) {
                    await auth.signInWithCustomToken(initialAuthToken);
                } else {
                    await auth.signInAnonymously();
                }

                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('user-id-display').value = userId;
                        showToast("Signed in successfully.");
                        startListeners();
                        renderPage('dashboard');
                    } else {
                        userId = null;
                        isAuthReady = false;
                        document.getElementById('user-id-display').value = 'Not signed in';
                        // Handle signed out state
                    }
                });
            } catch (error) {
                console.error("Error during Firebase initialization:", error);
                showToast("Firebase initialization failed.", 'error');
            }
        }
        // --- END: Firebase Configuration and Initialization ---


        // --- START: Data and State Management ---
        let state = {
            clients: [],
            projects: [],
            invoices: [],
            userProfile: {},
            invoiceDetails: {
                invoiceNumber: 'INV-' + Math.floor(Math.random() * 10000),
                invoiceDate: new Date().toISOString().split('T')[0],
                dueDate: new Date().toISOString().split('T')[0],
                client: null,
                items: [],
                subtotal: 0,
                taxRate: 0,
                total: 0,
                notes: '',
            }
        };

        function startListeners() {
            if (!isAuthReady) return;

            // Profile Listener
            const profileDocRef = db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('profile').doc('data');
            profileDocRef.onSnapshot(doc => {
                if (doc.exists) {
                    state.userProfile = doc.data();
                    renderProfilePage();
                    renderInvoicePreview();
                } else {
                    // Create default profile
                    profileDocRef.set({
                        brandName: 'My Brand',
                        contactInfo: { name: '', email: '', phone: '', address: '' },
                        paymentOptions: []
                    });
                }
            });

            // Clients Listener
            db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('clients')
                .onSnapshot(snapshot => {
                    state.clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderClientsPage();
                    renderClientsSelect();
                });

            // Projects Listener
            db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('projects')
                .onSnapshot(snapshot => {
                    state.projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderProjectsPage();
                    renderProjectsSelect();
                });

            // Invoices Listener
            db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('invoices')
                .onSnapshot(snapshot => {
                    state.invoices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Invoices are used for reports page, no need to re-render other pages here
                });
        }
        // --- END: Data and State Management ---


        // --- START: UI Rendering Functions ---
        function renderPage(pageId) {
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId + '-page').classList.add('active');

            // Update nav buttons
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                btn.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                if (btn.dataset.page === pageId) {
                    btn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                    btn.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                }
            });
            
            // Re-render the specific page's content
            if (pageId === 'profile') renderProfilePage();
            if (pageId === 'clients') renderClientsPage();
            if (pageId === 'projects') renderProjectsPage();
            if (pageId === 'reports') renderReportsPage();
        }

        function renderClientsSelect() {
            const clientSelect = document.getElementById('client-select');
            const reportClientSelect = document.getElementById('report-client-select');
            clientSelect.innerHTML = '<option value="" disabled selected>Select a client</option>';
            reportClientSelect.innerHTML = '<option value="" disabled selected>Select a client</option>';
            state.clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                clientSelect.appendChild(option);
                
                const reportOption = document.createElement('option');
                reportOption.value = client.id;
                reportOption.textContent = client.name;
                reportClientSelect.appendChild(reportOption);
            });
        }

        function renderProjectsSelect() {
            const projectSelect = document.getElementById('project-select');
            projectSelect.innerHTML = '<option value="" disabled selected>Search or select a project</option>';
            state.projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                projectSelect.appendChild(option);
            });
        }

        function renderClientsPage() {
            const clientsTableBody = document.getElementById('clients-table-body');
            clientsTableBody.innerHTML = '';
            state.clients.forEach(client => {
                const row = document.createElement('tr');
                row.className = 'bg-white dark:bg-gray-800';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${client.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${client.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${client.address}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="text-red-600 hover:text-red-900" onclick="deleteClient('${client.id}')">Delete</button>
                    </td>
                `;
                clientsTableBody.appendChild(row);
            });
        }

        function renderProjectsPage() {
            const projectsTableBody = document.getElementById('projects-table-body');
            projectsTableBody.innerHTML = '';
            state.projects.forEach(project => {
                const row = document.createElement('tr');
                row.className = 'bg-white dark:bg-gray-800';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${project.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${project.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">$${parseFloat(project.rate).toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${project.unit}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="text-red-600 hover:text-red-900" onclick="deleteProject('${project.id}')">Delete</button>
                    </td>
                `;
                projectsTableBody.appendChild(row);
            });
        }

        function renderProfilePage() {
            if (!state.userProfile.brandName) return;

            document.getElementById('brand-name-input').value = state.userProfile.brandName || '';
            document.getElementById('contact-name-input').value = state.userProfile.contactInfo?.name || '';
            document.getElementById('contact-email-input').value = state.userProfile.contactInfo?.email || '';
            document.getElementById('contact-phone-input').value = state.userProfile.contactInfo?.phone || '';
            document.getElementById('contact-address-input').value = state.userProfile.contactInfo?.address || '';

            const paymentOptionsContainer = document.getElementById('payment-options-container');
            paymentOptionsContainer.innerHTML = '';
            state.userProfile.paymentOptions?.forEach((option, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2';
                div.innerHTML = `
                    <input type="text" value="${option}" class="flex-grow rounded-md border-gray-300 shadow-sm p-2" onchange="updatePaymentOption(${index}, this.value)">
                    <button onclick="removePaymentOption(${index})" class="text-red-600 hover:text-red-900">&times;</button>
                `;
                paymentOptionsContainer.appendChild(div);
            });
        }

        function renderInvoiceItems() {
            const invoiceItemsBody = document.getElementById('invoice-items-body');
            invoiceItemsBody.innerHTML = '';
            state.invoiceDetails.items.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'bg-white dark:bg-gray-800';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap"><input type="text" value="${item.description}" class="w-full bg-transparent border-none" onchange="updateInvoiceItem(${index}, 'description', this.value)"></td>
                    <td class="px-6 py-4 whitespace-nowrap"><input type="number" value="${item.rate}" class="w-24 bg-transparent border-none text-right" onchange="updateInvoiceItem(${index}, 'rate', parseFloat(this.value))"></td>
                    <td class="px-6 py-4 whitespace-nowrap"><input type="number" value="${item.quantity}" class="w-24 bg-transparent border-none text-right" onchange="updateInvoiceItem(${index}, 'quantity', parseFloat(this.value))"></td>
                    <td class="px-6 py-4 whitespace-nowrap"><input type="text" value="${item.unit}" class="w-24 bg-transparent border-none" onchange="updateInvoiceItem(${index}, 'unit', this.value)"></td>
                    <td class="px-6 py-4 whitespace-nowrap font-semibold">$${item.total.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button class="text-red-600 hover:text-red-900" onclick="removeInvoiceItem(${index})">&times;</button>
                    </td>
                `;
                invoiceItemsBody.appendChild(row);
            });
        }

        function updateInvoiceTotals() {
            const subtotal = state.invoiceDetails.items.reduce((sum, item) => sum + item.total, 0);
            const taxAmount = subtotal * (state.invoiceDetails.taxRate / 100);
            const total = subtotal + taxAmount;

            state.invoiceDetails.subtotal = subtotal;
            state.invoiceDetails.total = total;

            document.getElementById('subtotal-display').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('tax-display').textContent = `$${taxAmount.toFixed(2)}`;
            document.getElementById('total-display').textContent = `$${total.toFixed(2)}`;
        }

        function renderInvoicePreview() {
             const data = state.invoiceDetails;
             const profile = state.userProfile;

             document.getElementById('pdf-brand-name').textContent = profile.brandName || 'Your Brand Name';
             document.getElementById('pdf-brand-address').textContent = profile.contactInfo?.address || 'Your address';
             document.getElementById('pdf-brand-email').textContent = profile.contactInfo?.email || 'Your email';
             document.getElementById('pdf-brand-phone').textContent = profile.contactInfo?.phone || 'Your phone';
             
             document.getElementById('pdf-invoice-number').textContent = `Invoice #${data.invoiceNumber}`;
             document.getElementById('pdf-invoice-date').textContent = `Date: ${data.invoiceDate ? dateFns.format(new Date(data.invoiceDate), 'PPP') : ''}`;
             document.getElementById('pdf-due-date').textContent = `Due: ${data.dueDate ? dateFns.format(new Date(data.dueDate), 'PPP') : ''}`;
             
             if (data.client) {
                 document.getElementById('pdf-client-name').textContent = data.client.name;
                 document.getElementById('pdf-client-email').textContent = data.client.email;
                 document.getElementById('pdf-client-address').textContent = data.client.address;
             } else {
                document.getElementById('pdf-client-name').textContent = 'No client selected';
                document.getElementById('pdf-client-email').textContent = '';
                document.getElementById('pdf-client-address').textContent = '';
             }

             const pdfItemsBody = document.getElementById('pdf-invoice-items');
             pdfItemsBody.innerHTML = '';
             data.items.forEach(item => {
                 const row = document.createElement('tr');
                 row.className = 'border-gray-200';
                 row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${item.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">$${parseFloat(item.rate).toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">${item.quantity} ${item.unit}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right font-semibold">$${parseFloat(item.total).toFixed(2)}</td>
                 `;
                 pdfItemsBody.appendChild(row);
             });

             document.getElementById('pdf-subtotal').textContent = `$${data.subtotal.toFixed(2)}`;
             document.getElementById('pdf-tax-rate').textContent = data.taxRate;
             document.getElementById('pdf-tax').textContent = `$${(data.subtotal * (data.taxRate / 100)).toFixed(2)}`;
             document.getElementById('pdf-total').textContent = `$${data.total.toFixed(2)}`;

             const pdfPaymentOptions = document.getElementById('pdf-payment-options-list');
             pdfPaymentOptions.innerHTML = '';
             if (profile.paymentOptions && profile.paymentOptions.length > 0) {
                 document.getElementById('pdf-payment-options-container').classList.remove('hidden');
                 profile.paymentOptions.forEach(option => {
                     const li = document.createElement('li');
                     li.textContent = option;
                     pdfPaymentOptions.appendChild(li);
                 });
             } else {
                 document.getElementById('pdf-payment-options-container').classList.add('hidden');
             }
        }
        // --- END: UI Rendering Functions ---


        // --- START: Event Handlers and Logic ---
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast show';
            if (type === 'error') {
                toast.style.backgroundColor = '#dc2626';
            }
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        async function handleSignOut() {
            try {
                await auth.signOut();
                showToast("Signed out successfully.");
            } catch (error) {
                console.error("Error signing out:", error);
                showToast("Error signing out.", 'error');
            }
        }

        async function handleSaveClient() {
            const name = document.getElementById('new-client-name').value;
            const email = document.getElementById('new-client-email').value;
            const address = document.getElementById('new-client-address').value;
            if (!userId || !name) {
                showToast("Client name is required.", 'error');
                return;
            }
            try {
                await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('clients').add({ name, email, address });
                document.getElementById('add-client-dialog').style.display = 'none';
                showToast("Client saved successfully.");
            } catch (error) {
                console.error("Error saving client:", error);
                showToast("Could not save client.", 'error');
            }
        }

        async function deleteClient(clientId) {
            try {
                await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('clients').doc(clientId).delete();
                showToast("Client deleted successfully.");
            } catch (error) {
                console.error("Error deleting client:", error);
                showToast("Could not delete client.", 'error');
            }
        }
        
        async function handleSaveProject() {
            const name = document.getElementById('new-project-name').value;
            const description = document.getElementById('new-project-description').value;
            const rate = document.getElementById('new-project-rate').value;
            const unit = document.getElementById('new-project-unit').value;
            if (!userId || !name) {
                showToast("Project name is required.", 'error');
                return;
            }
            try {
                await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('projects').add({ name, description, rate: parseFloat(rate), unit });
                document.getElementById('add-project-dialog').style.display = 'none';
                showToast("Project saved successfully.");
            } catch (error) {
                console.error("Error saving project:", error);
                showToast("Could not save project.", 'error');
            }
        }

        async function deleteProject(projectId) {
            try {
                await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('projects').doc(projectId).delete();
                showToast("Project deleted successfully.");
            } catch (error) {
                console.error("Error deleting project:", error);
                showToast("Could not delete project.", 'error');
            }
        }
        
        function addInvoiceItemFromProject() {
            const projectId = document.getElementById('project-select').value;
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            state.invoiceDetails.items.push({
                description: project.description,
                rate: project.rate,
                quantity: 1,
                unit: project.unit,
                total: project.rate * 1,
            });
            renderInvoiceItems();
            updateInvoiceTotals();
            renderInvoicePreview();
        }

        function updateInvoiceItem(index, field, value) {
            state.invoiceDetails.items[index][field] = value;
            const item = state.invoiceDetails.items[index];
            item.total = item.rate * item.quantity;
            updateInvoiceTotals();
            renderInvoicePreview();
        }

        function removeInvoiceItem(index) {
            state.invoiceDetails.items.splice(index, 1);
            renderInvoiceItems();
            updateInvoiceTotals();
            renderInvoicePreview();
        }
        
        async function handleGenerateInvoice() {
            const clientSelect = document.getElementById('client-select');
            const clientId = clientSelect.value;
            const client = state.clients.find(c => c.id === clientId);
            if (!client) {
                showToast("Please select a client.", 'error');
                return;
            }
            state.invoiceDetails.client = client;
            state.invoiceDetails.invoiceDate = document.getElementById('invoice-date').value;
            state.invoiceDetails.dueDate = document.getElementById('due-date').value;
            state.invoiceDetails.invoiceNumber = document.getElementById('invoice-number').value;

            try {
                await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('invoices').add({
                    ...state.invoiceDetails,
                    client: {
                        id: client.id,
                        name: client.name,
                        email: client.email,
                    },
                    createdAt: new Date(),
                    invoiceDate: new Date(state.invoiceDetails.invoiceDate),
                    dueDate: new Date(state.invoiceDetails.dueDate),
                });
                showToast("Invoice saved successfully.");
                handleDownloadInvoice();
            } catch (error) {
                console.error("Error saving invoice:", error);
                showToast("Could not save invoice.", 'error');
            }
        }
        
        async function handleDownloadInvoice() {
             renderInvoicePreview();
             const invoiceEl = document.getElementById('invoice-to-pdf');
             if (!invoiceEl) return;
             
             htmlToImage.toPng(invoiceEl)
                 .then(function (dataUrl) {
                     const { jsPDF } = window.jspdf;
                     const pdf = new jsPDF('p', 'mm', 'a4');
                     const imgProps = pdf.getImageProperties(dataUrl);
                     const pdfWidth = pdf.internal.pageSize.getWidth();
                     const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                     pdf.addImage(dataUrl, 'PNG', 0, 0, pdfWidth, pdfHeight);
                     pdf.save(`${state.invoiceDetails.invoiceNumber}_${state.invoiceDetails.invoiceDate}.pdf`);
                     showToast("Invoice downloaded.");
                 })
                 .catch(function (error) {
                     console.error('oops, something went wrong!', error);
                     showToast("Could not download invoice.", 'error');
                 });
        }
        
        async function handleGenerateReport() {
            const clientId = document.getElementById('report-client-select').value;
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;

            if (!clientId || !startDate || !endDate) {
                showToast("Please select a client and a date range.", 'error');
                return;
            }

            const selectedClient = state.clients.find(c => c.id === clientId);
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999);

            const filteredInvoices = state.invoices.filter(inv => {
                const invoiceDate = inv.createdAt.toDate();
                return inv.client.id === clientId && invoiceDate >= start && invoiceDate <= end;
            });

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            let y = 10;
            pdf.setFontSize(18);
            pdf.text(`Monthly Report for ${selectedClient.name}`, 10, y);
            y += 10;
            pdf.setFontSize(12);
            pdf.text(`Date Range: ${dateFns.format(start, 'MM/dd/yyyy')} - ${dateFns.format(end, 'MM/dd/yyyy')}`, 10, y);
            y += 15;

            filteredInvoices.forEach(inv => {
                pdf.text(`Invoice #${inv.invoiceNumber} | Date: ${dateFns.format(inv.createdAt.toDate(), 'MM/dd/yyyy')} | Total: $${inv.total.toFixed(2)}`, 15, y);
                y += 7;
            });

            pdf.save(`Report_${selectedClient.name}_${dateFns.format(start, 'yyyyMM')}.pdf`);
            showToast("Report downloaded successfully.");
        }
        
        async function handleSaveProfile() {
            const profileData = {
                brandName: document.getElementById('brand-name-input').value,
                contactInfo: {
                    name: document.getElementById('contact-name-input').value,
                    email: document.getElementById('contact-email-input').value,
                    phone: document.getElementById('contact-phone-input').value,
                    address: document.getElementById('contact-address-input').value,
                },
                paymentOptions: state.userProfile.paymentOptions || [],
            };
            try {
                const profileDocRef = db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('profile').doc('data');
                await profileDocRef.set(profileData, { merge: true });
                showToast("Profile saved successfully.");
            } catch (error) {
                console.error("Error saving profile:", error);
                showToast("Could not save profile.", 'error');
            }
        }

        async function updatePaymentOption(index, value) {
            state.userProfile.paymentOptions[index] = value;
        }

        function addPaymentOption() {
            const newOptions = state.userProfile.paymentOptions ? [...state.userProfile.paymentOptions, ''] : [''];
            state.userProfile.paymentOptions = newOptions;
            renderProfilePage();
        }

        async function removePaymentOption(index) {
            state.userProfile.paymentOptions.splice(index, 1);
            renderProfilePage();
            await handleSaveProfile();
        }

        async function handleDeleteAccount() {
             // In a real app, you would need a cloud function to delete all user data.
             // Here, we just sign out and show a message.
            try {
                await auth.signOut();
                showToast("Account deleted successfully (simulated).", 'error');
            } catch (error) {
                console.error("Error deleting account:", error);
                showToast("Could not delete account.", 'error');
            }
        }

        // --- END: Event Handlers and Logic ---


        // --- START: Event Listeners and Initial Setup ---
        window.onload = async () => {
            initFirebase();
        
            // Navigation
            document.querySelectorAll('.nav-button').forEach(button => {
                button.addEventListener('click', () => renderPage(button.dataset.page));
            });
            document.getElementById('sign-out-btn').addEventListener('click', handleSignOut);

            // Dashboard
            document.getElementById('invoice-date').value = state.invoiceDetails.invoiceDate;
            document.getElementById('due-date').value = state.invoiceDetails.dueDate;
            document.getElementById('invoice-number').value = state.invoiceDetails.invoiceNumber;
            document.getElementById('project-select').addEventListener('change', addInvoiceItemFromProject);
            document.getElementById('tax-rate-input').addEventListener('input', (e) => {
                state.invoiceDetails.taxRate = parseFloat(e.target.value);
                updateInvoiceTotals();
                renderInvoicePreview();
            });
            document.getElementById('client-select').addEventListener('change', (e) => {
                const client = state.clients.find(c => c.id === e.target.value);
                state.invoiceDetails.client = client;
                renderInvoicePreview();
            });
            document.getElementById('generate-invoice-btn').addEventListener('click', handleGenerateInvoice);
            document.getElementById('download-invoice-btn').addEventListener('click', handleDownloadInvoice);
            
            // Clients
            document.getElementById('add-client-dialog-btn').addEventListener('click', () => {
                document.getElementById('add-client-dialog').style.display = 'flex';
                document.getElementById('new-client-name').value = '';
                document.getElementById('new-client-email').value = '';
                document.getElementById('new-client-address').value = '';
            });
            document.getElementById('cancel-add-client-btn').addEventListener('click', () => document.getElementById('add-client-dialog').style.display = 'none');
            document.getElementById('save-client-btn').addEventListener('click', handleSaveClient);

            // Projects
            document.getElementById('add-project-dialog-btn').addEventListener('click', () => {
                document.getElementById('add-project-dialog').style.display = 'flex';
                document.getElementById('new-project-name').value = '';
                document.getElementById('new-project-description').value = '';
                document.getElementById('new-project-rate').value = 0;
                document.getElementById('new-project-unit').value = '';
            });
            document.getElementById('cancel-add-project-btn').addEventListener('click', () => document.getElementById('add-project-dialog').style.display = 'none');
            document.getElementById('save-project-btn').addEventListener('click', handleSaveProject);
            
            // Reports
            document.getElementById('download-report-btn').addEventListener('click', handleGenerateReport);

            // Profile
            document.getElementById('save-profile-btn').addEventListener('click', handleSaveProfile);
            document.getElementById('add-payment-option-btn').addEventListener('click', addPaymentOption);
            document.getElementById('delete-profile-btn').addEventListener('click', handleDeleteAccount);
        };
        // --- END: Event Listeners and Initial Setup ---
    </script>
</body>
</html>
