<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark blue-gray background */
            color: #e2e8f0; /* Light text color */
        }
        .container {
            max-width: 960px;
        }
        .bg-card {
            background-color: #2d3748; /* Slightly lighter dark background for cards */
        }
        .invoice-item-row {
            transition: all 0.3s ease;
            background-color: #2d3748;
        }
        .invoice-item-row:hover {
            transform: scale(1.01);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            background-color: #4a5568;
        }
        input, select, textarea {
            background-color: #4a5568;
            color: #e2e8f0;
            border-color: #4a5568;
        }
        input:focus, select:focus, textarea:focus {
          outline: none;
          box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5);
        }
        .form-label {
            color: #cbd5e0;
        }
        /* Custom styles for the search dropdown */
        .custom-select {
            position: relative;
        }
        .custom-select-options {
            position: absolute;
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #4a5568;
            background-color: #2d3748;
            width: 100%;
            border-radius: 0.375rem;
            margin-top: 0.25rem;
        }
        .custom-select-options div {
            padding: 0.5rem;
            cursor: pointer;
        }
        .custom-select-options div:hover {
            background-color: #4a5568;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    
    <!-- Login/Authentication Screen -->
    <div id="login-screen" class="container bg-card p-8 rounded-xl shadow-lg w-full border border-gray-700 flex flex-col items-center justify-center space-y-6">
        <h1 class="text-4xl font-bold text-center text-indigo-400">Welcome to Invoice App</h1>
        <p class="text-lg text-gray-400">Please log in to continue.</p>
        
        <!-- Email/Password Login Form -->
        <div class="w-full max-w-sm space-y-4">
            <div>
                <label for="email-input" class="form-label block text-sm font-medium">Email Address</label>
                <input type="email" id="email-input" class="mt-1 block w-full rounded-md shadow-sm p-2 border" placeholder="you@example.com">
            </div>
            <div>
                <label for="password-input" class="form-label block text-sm font-medium">Password</label>
                <input type="password" id="password-input" class="mt-1 block w-full rounded-md shadow-sm p-2 border" placeholder="********">
            </div>
            <div class="flex space-x-4">
                <button id="email-signin-btn" class="flex-1 bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105">
                    Sign In
                </button>
                <button id="email-signup-btn" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105">
                    Sign Up
                </button>
            </div>
        </div>

        <!-- Separator -->
        <div class="flex items-center w-full max-w-sm my-4">
            <hr class="flex-grow border-gray-600">
            <span class="px-3 text-gray-500 text-sm">OR</span>
            <hr class="flex-grow border-gray-600">
        </div>

        <!-- Google Login Button -->
        <button id="google-login-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105 flex items-center justify-center space-x-2 w-full max-w-sm">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M21.365 10.596h-9.365v3.407h5.361c-.26 1.488-1.272 3.522-5.361 3.522-3.215 0-5.834-2.67-5.834-5.96s2.619-5.96 5.834-5.96c1.761 0 2.923.753 3.606 1.393l2.672-2.585c-1.637-1.498-3.702-2.457-6.278-2.457-5.161 0-9.365 4.199-9.365 9.365s4.204 9.365 9.365 9.365c5.313 0 8.948-3.722 8.948-9.14 0-.841-.073-1.459-.168-2.072z"/>
            </svg>
            <span>Sign In with Google</span>
        </button>
    </div>

    <!-- Main Application Container -->
    <div id="main-app" class="container bg-card p-8 rounded-xl shadow-lg w-full border border-gray-700 hidden">
        <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
            <h1 class="text-4xl font-bold text-indigo-400">Invoice App</h1>
            <!-- User Profile and Logout -->
            <div id="profile-section" class="flex items-center space-x-4">
                <div class="text-right">
                    <p class="text-gray-300">Logged in as: <span id="user-email" class="font-semibold text-indigo-400"></span></p>
                    <p class="text-gray-500 text-xs">ID: <span id="user-id" class="font-mono"></span></p>
                </div>
                <button id="logout-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-4 rounded-full transition-transform transform hover:scale-105">
                    Logout
                </button>
            </div>
        </div>
        
        <!-- Tabs for different sections -->
        <div class="flex mb-6 space-x-2 border-b border-gray-700">
            <button id="tab-invoice" class="px-4 py-2 text-gray-400 font-medium border-b-2 border-transparent hover:text-indigo-400 hover:border-indigo-400 focus:outline-none">Invoice</button>
            <button id="tab-products" class="px-4 py-2 text-gray-400 font-medium border-b-2 border-transparent hover:text-indigo-400 hover:border-indigo-400 focus:outline-none">Products</button>
            <button id="tab-clients" class="px-4 py-2 text-gray-400 font-medium border-b-2 border-transparent hover:text-indigo-400 hover:border-indigo-400 focus:outline-none">Clients</button>
            <button id="tab-reports" class="px-4 py-2 text-gray-400 font-medium border-b-2 border-transparent hover:text-indigo-400 hover:border-indigo-400 focus:outline-none">Reports</button>
        </div>

        <!-- Tab Content Containers -->
        <div id="content-container" class="mt-6">
            <!-- Invoice Tab Content -->
            <div id="content-invoice" class="tab-content">
                <h2 class="text-2xl font-semibold mb-4 text-gray-200">Create New Invoice</h2>
                <div class="space-y-4">
                    <!-- Client Dropdown -->
                    <div class="custom-select">
                        <label for="clientNameInput" class="form-label block text-sm font-medium">Client</label>
                        <input type="text" id="clientNameInput" placeholder="Select or type client name" class="mt-1 block w-full rounded-md shadow-sm p-2 border" autocomplete="off">
                        <div id="client-suggestions" class="custom-select-options hidden"></div>
                        <input type="hidden" id="selectedClientId">
                    </div>
                    <!-- Product Dropdown -->
                    <div class="custom-select">
                        <label for="productSelect" class="form-label block text-sm font-medium">Add Product</label>
                        <div class="flex items-center space-x-2">
                             <select id="productSelect" class="mt-1 block w-full rounded-md shadow-sm p-2 border">
                                <option value="">Select a product</option>
                            </select>
                             <button id="addProductToInvoiceBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 mt-1">Add</button>
                        </div>
                    </div>
                    <div>
                        <label for="invoiceDate" class="form-label block text-sm font-medium">Invoice Date</label>
                        <input type="date" id="invoiceDate" class="mt-1 block w-full rounded-md shadow-sm p-2 border">
                    </div>
                </div>

                <!-- Invoice Items for the current invoice -->
                <h3 class="text-xl font-semibold mt-6 mb-4 text-gray-200">Invoice Items</h3>
                <div class="flex space-x-2 items-center text-gray-400 font-medium pb-2 border-b border-gray-600">
                    <div class="flex-1">Product Name</div>
                    <div class="w-16 text-right">Qty</div>
                    <div class="w-24 text-right">Price</div>
                    <div class="w-24 text-right">Amount</div>
                    <div class="w-10"></div>
                </div>
                <div id="invoice-items" class="mt-3 space-y-3">
                    <!-- Item rows will be appended here -->
                </div>
                <button id="addItemBtn" class="mt-4 bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    Add Custom Item
                </button>
                
                <div class="mt-6 p-4 bg-gray-700 rounded-lg">
                    <div class="flex justify-between font-bold text-lg text-gray-200">
                        <span>Total:</span>
                        <span id="totalAmount">Rs. 0.00</span>
                    </div>
                </div>
                
                <div class="flex space-x-4 mt-6">
                    <button id="generateInvoiceBtn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-transform transform hover:scale-105">
                        Generate & Download Invoice
                    </button>
                    <button id="saveInvoiceBtn" class="flex-1 bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-transform transform hover:scale-105">
                        Save Invoice
                    </button>
                </div>
            </div>

            <!-- Products Tab Content -->
            <div id="content-products" class="tab-content hidden">
                <h2 class="text-2xl font-semibold mb-4 text-gray-200">Manage Products</h2>
                
                <!-- Section to create a new product -->
                <div class="p-4 bg-gray-700 rounded-lg mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-200">Add New Product</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="productNameInput" class="form-label block text-sm font-medium">Product Name</label>
                            <input type="text" id="productNameInput" class="mt-1 block w-full rounded-md shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="productPriceInput" class="form-label block text-sm font-medium">Price</label>
                            <input type="number" id="productPriceInput" min="0" step="0.01" class="mt-1 block w-full rounded-md shadow-sm p-2 border">
                        </div>
                    </div>
                    <button id="saveProductBtn" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-xl shadow-lg transition-transform transform hover:scale-105">
                        Save Product
                    </button>
                </div>

                <!-- List of existing products -->
                <h3 class="text-xl font-semibold mb-4 text-gray-200">Existing Products</h3>
                <div id="products-list" class="space-y-4">
                    <!-- Saved products will be rendered here -->
                </div>
            </div>

            <!-- Clients Tab Content -->
            <div id="content-clients" class="tab-content hidden">
                <h2 class="text-2xl font-semibold mb-4 text-gray-200">Manage Clients</h2>
                <div id="clients-list" class="space-y-4">
                    <!-- Saved clients will be rendered here -->
                </div>
                <div class="mt-6 p-4 bg-gray-700 rounded-lg space-y-4">
                    <h3 class="text-xl font-semibold text-gray-200">Add New Client</h3>
                    <div>
                        <label for="newClientNameInput" class="form-label block text-sm font-medium">Client Name</label>
                        <input type="text" id="newClientNameInput" class="mt-1 block w-full rounded-md shadow-sm p-2 border">
                    </div>
                    <button id="saveClientBtn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-xl shadow-lg transition-transform transform hover:scale-105">
                        Save Client
                    </button>
                </div>
            </div>
            
            <!-- Reports Tab Content -->
            <div id="content-reports" class="tab-content hidden">
                <h2 class="text-2xl font-semibold mb-4 text-gray-200">Monthly Reports</h2>
                <div class="space-y-4 p-4 bg-gray-700 rounded-lg">
                    <div class="custom-select">
                        <label for="reportClientInput" class="form-label block text-sm font-medium">Select Client for Report</label>
                        <input type="text" id="reportClientInput" placeholder="Search for a client" class="mt-1 block w-full rounded-md shadow-sm p-2 border" autocomplete="off">
                        <div id="report-client-suggestions" class="custom-select-options hidden"></div>
                        <input type="hidden" id="selectedReportClientId">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="reportStartDate" class="form-label block text-sm font-medium">Start Date</label>
                            <input type="date" id="reportStartDate" class="mt-1 block w-full rounded-md shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="reportEndDate" class="form-label block text-sm font-medium">End Date</label>
                            <input type="date" id="reportEndDate" class="mt-1 block w-full rounded-md shadow-sm p-2 border">
                        </div>
                    </div>
                    <button id="generateReportBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-transform transform hover:scale-105">
                        Generate Report
                    </button>
                </div>
            </div>
        </div>

        <!-- Saved Invoices Section -->
        <div id="saved-invoices-section" class="mt-10 border-t-2 border-gray-700 pt-6">
            <h2 class="text-2xl font-semibold mb-4 text-gray-200">Saved Invoices</h2>
            <div id="invoices-list" class="space-y-4">
                <!-- Saved invoices will be rendered here -->
            </div>
        </div>

    </div>

    <!-- The modal for displaying messages -->
    <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4">
      <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full border border-gray-700">
        <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-100">Message</h3>
        <p id="modal-message" class="text-gray-300 mb-4">This is a message box.</p>
        <button id="modal-close-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg">OK</button>
      </div>
    </div>
    
    <!-- Firebase script -->
    <script type="module">
        // Import the functions you need from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyDQvGFLq6cHWf9n9UsR1OwCVwsyKYC7Rao",
            authDomain: "invoice-bd8a1.firebaseapp.com",
            projectId: "invoice-bd8a1",
            storageBucket: "invoice-bd8a1.firebasestorage.app",
            messagingSenderId: "804369018747",
            appId: "1:804369018747:web:43ef3e1ac81a352b5097de",
            measurementId: "G-QDRK0SBCVY"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let userId = null;
        let savedClients = [];
        let savedProducts = [];

        // UI elements
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        const userEmailSpan = document.getElementById('user-email');
        const userIdSpan = document.getElementById('user-id');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const savedInvoicesSection = document.getElementById('saved-invoices-section');
        const invoicesList = document.getElementById('invoices-list');
        const saveInvoiceBtn = document.getElementById('saveInvoiceBtn');
        const generateInvoiceBtn = document.getElementById('generateInvoiceBtn');

        // New elements for email/password login
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const emailSignInBtn = document.getElementById('email-signin-btn');
        const emailSignUpBtn = document.getElementById('email-signup-btn');

        // Tabs
        const tabInvoice = document.getElementById('tab-invoice');
        const tabProducts = document.getElementById('tab-products');
        const tabClients = document.getElementById('tab-clients');
        const tabReports = document.getElementById('tab-reports');
        const contentInvoice = document.getElementById('content-invoice');
        const contentProducts = document.getElementById('content-products');
        const contentClients = document.getElementById('content-clients');
        const contentReports = document.getElementById('content-reports');

        // Products Tab
        const productsList = document.getElementById('products-list');
        const productNameInput = document.getElementById('productNameInput');
        const productPriceInput = document.getElementById('productPriceInput');
        const saveProductBtn = document.getElementById('saveProductBtn');

        // Clients Tab
        const clientsList = document.getElementById('clients-list');
        const saveClientBtn = document.getElementById('saveClientBtn');
        const newClientNameInput = document.getElementById('newClientNameInput');
        
        // Invoice Tab
        const productSelect = document.getElementById('productSelect');
        const addProductToInvoiceBtn = document.getElementById('addProductToInvoiceBtn');
        const clientNameInput = document.getElementById('clientNameInput');
        const clientSuggestions = document.getElementById('client-suggestions');
        const selectedClientId = document.getElementById('selectedClientId');
        const invoiceItemsContainer = document.getElementById('invoice-items');
        const addItemBtn = document.getElementById('addItemBtn');
        const totalAmountSpan = document.getElementById('totalAmount');
        const invoiceDate = document.getElementById('invoiceDate');
        
        // Reports Tab
        const reportClientInput = document.getElementById('reportClientInput');
        const reportClientSuggestions = document.getElementById('report-client-suggestions');
        const selectedReportClientId = document.getElementById('selectedReportClientId');
        const reportStartDate = document.getElementById('reportStartDate');
        const reportEndDate = document.getElementById('reportEndDate');
        const generateReportBtn = document.getElementById('generateReportBtn');
        
        // Message Modal
        const messageModal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // Function to show a custom modal instead of alert
        function showMessage(title, message) {
          modalTitle.textContent = title;
          modalMessage.textContent = message;
          messageModal.classList.remove('hidden');
          messageModal.classList.add('flex');
        }

        modalCloseBtn.addEventListener('click', () => {
          messageModal.classList.add('hidden');
          messageModal.classList.remove('flex');
        });
        
        // Firebase Auth State Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in.
                userId = user.uid;
                const email = user.email || "User";
                loginScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                userEmailSpan.textContent = email;
                userIdSpan.textContent = userId;
                
                // Start listening to the user's private data
                listenForInvoices(userId);
                listenForProducts(userId);
                listenForClients(userId);

                // Set initial tab
                switchTab('invoice');
            } else {
                // User is signed out.
                userId = null;
                loginScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
                invoicesList.innerHTML = '';
                productsList.innerHTML = '';
                clientsList.innerHTML = '';
                productSelect.innerHTML = '<option value="">Select a product</option>';
            }
        });
        
        // Email Sign Up
        emailSignUpBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (email && password) {
                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                    showMessage("Success", "Account created successfully! You are now logged in.");
                } catch (error) {
                    console.error("Sign up failed:", error);
                    showMessage("Sign Up Failed", error.message);
                }
            } else {
                showMessage("Input Required", "Please enter a valid email and password.");
            }
        });

        // Email Sign In
        emailSignInBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (email && password) {
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    showMessage("Success", "Signed in successfully!");
                } catch (error) {
                    console.error("Sign in failed:", error);
                    showMessage("Sign In Failed", error.message);
                }
            } else {
                showMessage("Input Required", "Please enter a valid email and password.");
            }
        });

        // Google Login functionality
        googleLoginBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google login failed:", error);
                showMessage("Login Failed", "There was an error signing in with Google.");
            }
        });

        // Logout functionality
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showMessage("Logged Out", "You have been logged out successfully.");
            } catch (error) {
                console.error("Logout failed:", error);
                showMessage("Logout Failed", "There was an error logging out.");
            }
        });
        
        // Tab Switching Logic
        const tabButtons = [tabInvoice, tabProducts, tabClients, tabReports];
        const tabContents = [contentInvoice, contentProducts, contentClients, contentReports];
        
        function switchTab(tabId) {
            tabButtons.forEach(btn => {
                btn.classList.remove('border-indigo-400', 'text-indigo-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            tabContents.forEach(content => content.classList.add('hidden'));

            const activeTab = document.getElementById(`tab-${tabId}`);
            const activeContent = document.getElementById(`content-${tabId}`);
            
            activeTab.classList.remove('border-transparent', 'text-gray-400');
            activeTab.classList.add('border-indigo-400', 'text-indigo-400');
            activeContent.classList.remove('hidden');
            
            // Re-initialize item lists on tab switch to clear old data
            if (tabId === 'products') {
                productNameInput.value = '';
                productPriceInput.value = '';
            } else if (tabId === 'invoice') {
                invoiceItemsContainer.innerHTML = '';
                invoiceItemsContainer.appendChild(createInvoiceItemRow());
                updateInvoiceTotal();
                productSelect.value = '';
            }
        }
        
        tabInvoice.addEventListener('click', () => switchTab('invoice'));
        tabProducts.addEventListener('click', () => switchTab('products'));
        tabClients.addEventListener('click', () => switchTab('clients'));
        tabReports.addEventListener('click', () => switchTab('reports'));

        // Item row creation function for Invoice
        function createInvoiceItemRow(item = {}) {
            const row = document.createElement('div');
            row.className = 'invoice-item-row flex space-x-2 items-center p-2 rounded-lg shadow-sm';
            row.innerHTML = `
                <input type="text" value="${item.productName || ''}" placeholder="Product Name" class="flex-1 rounded-md border-gray-600 p-1 border">
                <input type="number" value="${item.quantity || 1}" min="1" class="w-16 text-right rounded-md border-gray-600 p-1 border">
                <input type="number" value="${item.price || 0}" min="0" step="0.01" class="w-24 text-right rounded-md border-gray-600 p-1 border">
                <span class="amount-cell w-24 text-right font-medium text-gray-300">Rs. 0.00</span>
                <button class="remove-item-btn w-10 bg-red-500 hover:bg-red-600 text-white font-bold rounded-full h-8 w-8 flex items-center justify-center transition-transform transform hover:scale-110">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            `;
            
            const [productNameInput, quantityInput, priceInput] = row.querySelectorAll('input');
            const amountCell = row.querySelector('.amount-cell');
            const removeBtn = row.querySelector('.remove-item-btn');

            const updateAmount = () => {
                const quantity = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                const amount = quantity * price;
                amountCell.textContent = `Rs. ${amount.toFixed(2)}`;
                updateInvoiceTotal();
            };

            quantityInput.addEventListener('input', updateAmount);
            priceInput.addEventListener('input', updateAmount);
            removeBtn.addEventListener('click', () => {
                row.remove();
                updateInvoiceTotal();
            });

            updateAmount(); // Initial calculation
            return row;
        }

        // Function to update total for the invoice
        function updateInvoiceTotal() {
            let total = 0;
            invoiceItemsContainer.querySelectorAll('.invoice-item-row').forEach(row => {
                const quantity = parseFloat(row.querySelectorAll('input')[1].value) || 0;
                const price = parseFloat(row.querySelectorAll('input')[2].value) || 0;
                total += quantity * price;
            });
            totalAmountSpan.textContent = `Rs. ${total.toFixed(2)}`;
        }
        
        // Initial item row for Invoice forms
        invoiceItemsContainer.appendChild(createInvoiceItemRow());

        // Add custom item to invoice
        addItemBtn.addEventListener('click', () => {
            invoiceItemsContainer.appendChild(createInvoiceItemRow());
        });
        
        // Client and Product Search Dropdown Logic
        function setupSearchableDropdown(inputElement, suggestionsContainer, data, onSelectCallback) {
            inputElement.addEventListener('input', () => {
                const query = inputElement.value.toLowerCase();
                suggestionsContainer.innerHTML = '';
                if (query.length > 0) {
                    const filteredData = data.filter(item => item.name.toLowerCase().includes(query));
                    if (filteredData.length > 0) {
                        filteredData.forEach(item => {
                            const suggestionDiv = document.createElement('div');
                            suggestionDiv.textContent = item.name;
                            suggestionDiv.addEventListener('click', () => {
                                onSelectCallback(item);
                                suggestionsContainer.classList.add('hidden');
                            });
                            suggestionsContainer.appendChild(suggestionDiv);
                        });
                        suggestionsContainer.classList.remove('hidden');
                    } else {
                        suggestionsContainer.classList.add('hidden');
                    }
                } else {
                    suggestionsContainer.classList.add('hidden');
                }
            });
            
            inputElement.addEventListener('focus', () => {
                if (inputElement.value.length === 0 && data.length > 0) {
                    suggestionsContainer.innerHTML = '';
                    data.forEach(item => {
                        const suggestionDiv = document.createElement('div');
                        suggestionDiv.textContent = item.name;
                        suggestionDiv.addEventListener('click', () => {
                            onSelectCallback(item);
                            suggestionsContainer.classList.add('hidden');
                        });
                        suggestionsContainer.appendChild(suggestionDiv);
                    });
                    suggestionsContainer.classList.remove('hidden');
                }
            });

            document.addEventListener('click', (e) => {
                if (!inputElement.parentElement.contains(e.target)) {
                    suggestionsContainer.classList.add('hidden');
                }
            });
        }
        
        // Invoice functionality
        function getInvoiceData() {
            const clientName = clientNameInput.value.trim();
            const invoiceDateValue = invoiceDate.value;

            if (!clientName || !invoiceDateValue) {
                showMessage("Missing Information", "Please enter a client name and invoice date.");
                return null;
            }

            const items = [];
            invoiceItemsContainer.querySelectorAll('.invoice-item-row').forEach(row => {
                const [productNameInput, quantityInput, priceInput] = row.querySelectorAll('input');
                const productName = productNameInput.value.trim();
                const quantity = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                if (productName && quantity > 0 && price >= 0) {
                    items.push({ productName, quantity, price, amount: quantity * price });
                }
            });

            if (items.length === 0) {
                showMessage("No Items", "Please add at least one valid item to the invoice.");
                return null;
            }

            const totalAmount = items.reduce((sum, item) => sum + item.amount, 0);

            return { clientName, invoiceDate: invoiceDateValue, items, totalAmount, createdAt: new Date() };
        }

        function clearInvoiceForm() {
            clientNameInput.value = '';
            invoiceDate.value = '';
            invoiceItemsContainer.innerHTML = '';
            invoiceItemsContainer.appendChild(createInvoiceItemRow());
            updateInvoiceTotal();
            productSelect.value = '';
        }

        // Save invoice to Firestore
        saveInvoiceBtn.addEventListener('click', async () => {
            if (!userId) {
                showMessage("Login Required", "Please log in to save your invoice.");
                return;
            }
            const newInvoice = getInvoiceData();
            if (!newInvoice) return;
            try {
                const invoiceCollection = collection(db, `artifacts/${appId}/users/${userId}/invoices`);
                await addDoc(invoiceCollection, newInvoice);
                showMessage("Success", "Invoice saved successfully!");
                clearInvoiceForm();
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage("Error", "Failed to save the invoice. Please try again.");
            }
        });

        // Generate and Download Invoice
        generateInvoiceBtn.addEventListener('click', async () => {
            const invoiceData = getInvoiceData();
            if (!invoiceData) return;

            // Save the invoice to Firestore first
            if (userId) {
                try {
                    const invoiceCollection = collection(db, `artifacts/${appId}/users/${userId}/invoices`);
                    await addDoc(invoiceCollection, invoiceData);
                } catch (e) {
                    console.error("Error saving invoice on generate: ", e);
                }
            }

            // Create the HTML for the downloadable invoice
            const invoiceHtml = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <title>Invoice for ${invoiceData.clientName}</title>
                    <style>
                        body { font-family: sans-serif; margin: 2rem; color: #333; }
                        .invoice-container { max-width: 800px; margin: auto; padding: 20px; border: 1px solid #ddd; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
                        .header { text-align: center; margin-bottom: 20px; }
                        .header h1 { color: #3b82f6; }
                        .details { display: flex; justify-content: space-between; margin-bottom: 20px; }
                        .details div { width: 48%; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .total { text-align: right; margin-top: 20px; font-size: 1.2rem; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <div class="invoice-container">
                        <div class="header">
                            <h1>Invoice</h1>
                            <p>Invoice Date: ${invoiceData.invoiceDate}</p>
                        </div>
                        <div class="details">
                            <div>
                                <strong>Bill To:</strong>
                                <p>${invoiceData.clientName}</p>
                            </div>
                            <div>
                                <strong>From:</strong>
                                <p>Your Company Name</p>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Product Name</th>
                                    <th>Qty</th>
                                    <th>Price</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invoiceData.items.map(item => `
                                    <tr>
                                        <td>${item.productName}</td>
                                        <td>${item.quantity}</td>
                                        <td>Rs. ${item.price.toFixed(2)}</td>
                                        <td>Rs. ${item.amount.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="total">
                            Total: Rs. ${invoiceData.totalAmount.toFixed(2)}
                        </div>
                    </div>
                </body>
                </html>
            `;

            // Create and download the HTML file
            const blob = new Blob([invoiceHtml], { type: 'text/html' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `invoice-${invoiceData.clientName}-${invoiceData.invoiceDate}.html`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showMessage("Invoice Generated", `Invoice for ${invoiceData.clientName} has been generated and downloaded. It has also been saved to your account.`);
            clearInvoiceForm();
        });


        // Listen for real-time updates to invoices
        function listenForInvoices(uid) {
            const invoicesRef = collection(db, `artifacts/${appId}/users/${uid}/invoices`);
            onSnapshot(invoicesRef, (querySnapshot) => {
                invoicesList.innerHTML = ''; // Clear previous list
                if (querySnapshot.empty) {
                    invoicesList.innerHTML = '<p class="text-gray-400">No invoices saved yet.</p>';
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const invoiceData = doc.data();
                    const invoiceId = doc.id;
                    const invoiceElement = createInvoiceDisplay(invoiceData, invoiceId);
                    invoicesList.appendChild(invoiceElement);
                });
            });
        }
        
        // Function to delete an invoice
        async function deleteInvoice(invoiceId) {
            if (!userId) {
                showMessage("Error", "You must be logged in to delete invoices.");
                return;
            }
            try {
                const invoiceRef = doc(db, `artifacts/${appId}/users/${userId}/invoices`, invoiceId);
                await deleteDoc(invoiceRef);
                showMessage("Deleted", "Invoice deleted successfully.");
            } catch (e) {
                console.error("Error removing document: ", e);
                showMessage("Error", "Failed to delete the invoice.");
            }
        }

        // Create HTML element for a saved invoice
        function createInvoiceDisplay(invoiceData, invoiceId) {
            const element = document.createElement('div');
            element.className = 'bg-gray-700 p-4 rounded-lg shadow-sm border border-gray-600 hover:shadow-md transition-shadow';
            
            const date = new Date(invoiceData.invoiceDate);
            const formattedDate = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            
            element.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-bold text-lg text-gray-200">${invoiceData.clientName}</h4>
                    <span class="text-sm text-gray-400">${formattedDate}</span>
                </div>
                <p class="text-sm text-gray-400 mb-2">Items: ${invoiceData.items.length}</p>
                <div class="flex justify-between items-center">
                    <span class="font-bold text-xl text-indigo-400">Total: Rs. ${invoiceData.totalAmount.toFixed(2)}</span>
                    <button class="delete-btn bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-3 rounded-full transition-transform transform hover:scale-105">Delete</button>
                </div>
            `;
            
            const deleteBtn = element.querySelector('.delete-btn');
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteInvoice(invoiceId);
            });
            
            return element;
        }

        // =================================================================================================
        // New Features Logic: Products, Clients, and Reports
        // =================================================================================================

        // Products Logic
        function listenForProducts(uid) {
            const productsRef = collection(db, `artifacts/${appId}/users/${uid}/products`);
            onSnapshot(productsRef, (querySnapshot) => {
                productsList.innerHTML = '';
                productSelect.innerHTML = '<option value="">Select a product</option>';
                savedProducts = [];
                querySnapshot.forEach((doc) => {
                    const productData = doc.data();
                    const productId = doc.id;
                    savedProducts.push({ id: productId, name: productData.productName, price: productData.price });
                    // Populate the Products tab
                    const productElement = createProductDisplay(productData, productId);
                    productsList.appendChild(productElement);
                    // Populate the dropdown in the invoice form
                    const option = document.createElement('option');
                    option.value = productId;
                    option.textContent = `${productData.productName} (Rs. ${productData.price.toFixed(2)})`;
                    productSelect.appendChild(option);
                });
            });
        }
        
        function createProductDisplay(productData, productId) {
            const element = document.createElement('div');
            element.className = 'bg-gray-700 p-4 rounded-lg shadow-sm border border-gray-600 flex justify-between items-center hover:shadow-md transition-shadow';
            element.innerHTML = `
                <h4 class="font-bold text-lg text-gray-200">${productData.productName}</h4>
                <div class="flex items-center space-x-4">
                    <span class="font-semibold text-indigo-400">Rs. ${productData.price.toFixed(2)}</span>
                    <button class="delete-product-btn bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-3 rounded-full transition-transform transform hover:scale-105">Delete</button>
                </div>
            `;
            element.querySelector('.delete-product-btn').addEventListener('click', () => {
                deleteProduct(productId);
            });
            return element;
        }

        async function deleteProduct(productId) {
            if (!userId) return;
            try {
                const productRef = doc(db, `artifacts/${appId}/users/${userId}/products`, productId);
                await deleteDoc(productRef);
                showMessage("Deleted", "Product deleted successfully.");
            } catch (e) {
                console.error("Error deleting product: ", e);
                showMessage("Error", "Failed to delete product.");
            }
        }

        saveProductBtn.addEventListener('click', async () => {
            if (!userId) {
                showMessage("Login Required", "Please log in to save products.");
                return;
            }
            const productName = productNameInput.value.trim();
            const productPrice = parseFloat(productPriceInput.value) || 0;
            if (!productName || productPrice < 0) {
                showMessage("Missing Information", "Please enter a product name and a valid price.");
                return;
            }
            try {
                const productsCollection = collection(db, `artifacts/${appId}/users/${userId}/products`);
                await addDoc(productsCollection, { productName, price: productPrice });
                showMessage("Success", "Product saved successfully!");
                productNameInput.value = '';
                productPriceInput.value = '';
            } catch (e) {
                console.error("Error saving product: ", e);
                showMessage("Error", "Failed to save product.");
            }
        });

        // Add a product from the dropdown to the invoice form
        addProductToInvoiceBtn.addEventListener('click', () => {
            const productId = productSelect.value;
            if (!productId) {
                showMessage("Selection Required", "Please select a product from the list.");
                return;
            }
            const selectedProduct = savedProducts.find(p => p.id === productId);
            if (selectedProduct) {
                invoiceItemsContainer.appendChild(createInvoiceItemRow({
                    productName: selectedProduct.name,
                    quantity: 1, 
                    price: selectedProduct.price
                }));
                updateInvoiceTotal();
            }
        });


        // Clients Logic
        function listenForClients(uid) {
            const clientsRef = collection(db, `artifacts/${appId}/users/${uid}/clients`);
            onSnapshot(clientsRef, (querySnapshot) => {
                clientsList.innerHTML = '';
                savedClients = [];
                querySnapshot.forEach((doc) => {
                    const clientData = doc.data();
                    const clientId = doc.id;
                    savedClients.push({ id: clientId, name: clientData.clientName });
                    // Populate the Clients tab
                    const clientElement = createClientDisplay(clientData, clientId);
                    clientsList.appendChild(clientElement);
                });
                // Re-setup the client search dropdowns with the new data
                setupSearchableDropdown(clientNameInput, clientSuggestions, savedClients, (client) => {
                    clientNameInput.value = client.name;
                    selectedClientId.value = client.id;
                });
                setupSearchableDropdown(reportClientInput, reportClientSuggestions, savedClients, (client) => {
                    reportClientInput.value = client.name;
                    selectedReportClientId.value = client.id;
                });
            });
        }
        
        function createClientDisplay(clientData, clientId) {
            const element = document.createElement('div');
            element.className = 'bg-gray-700 p-4 rounded-lg shadow-sm border border-gray-600 flex justify-between items-center hover:shadow-md transition-shadow';
            element.innerHTML = `
                <h4 class="font-bold text-lg text-gray-200">${clientData.clientName}</h4>
                <div class="space-x-2">
                    <button class="delete-client-btn bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-3 rounded-full transition-transform transform hover:scale-105">Delete</button>
                </div>
            `;
            element.querySelector('.delete-client-btn').addEventListener('click', () => {
                deleteClient(clientId);
            });
            return element;
        }

        async function deleteClient(clientId) {
            if (!userId) return;
            try {
                const clientRef = doc(db, `artifacts/${appId}/users/${userId}/clients`, clientId);
                await deleteDoc(clientRef);
                showMessage("Deleted", "Client deleted successfully.");
            } catch (e) {
                console.error("Error deleting client: ", e);
                showMessage("Error", "Failed to delete client.");
            }
        }

        saveClientBtn.addEventListener('click', async () => {
            if (!userId) {
                showMessage("Login Required", "Please log in to save clients.");
                return;
            }
            const clientName = newClientNameInput.value.trim();
            if (!clientName) {
                showMessage("Missing Information", "Please enter a client name.");
                return;
            }
            try {
                const clientsCollection = collection(db, `artifacts/${appId}/users/${userId}/clients`);
                await addDoc(clientsCollection, { clientName });
                showMessage("Success", "Client saved successfully!");
                newClientNameInput.value = '';
            } catch (e) {
                console.error("Error saving client: ", e);
                showMessage("Error", "Failed to save client.");
            }
        });

        // Reports Logic
        generateReportBtn.addEventListener('click', async () => {
            if (!userId) {
                showMessage("Login Required", "Please log in to generate reports.");
                return;
            }
            const clientId = selectedReportClientId.value;
            const clientName = reportClientInput.value;
            const startDate = reportStartDate.value;
            const endDate = reportEndDate.value;

            if (!clientId || !startDate || !endDate) {
                showMessage("Missing Information", "Please select a client and a date range.");
                return;
            }

            try {
                // Fetch invoices for the selected client and date range
                const invoicesRef = collection(db, `artifacts/${appId}/users/${userId}/invoices`);
                const q = query(
                    invoicesRef,
                    where("clientName", "==", clientName),
                );
                const querySnapshot = await getDocs(q);

                const invoices = [];
                querySnapshot.forEach(doc => {
                    const invoice = doc.data();
                    const invoiceDate = new Date(invoice.invoiceDate);
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    if (invoiceDate >= start && invoiceDate <= end) {
                        invoices.push(invoice);
                    }
                });

                if (invoices.length === 0) {
                    showMessage("No Invoices Found", "No invoices found for this client in the selected date range.");
                    return;
                }

                // Generate the report HTML
                const reportHtml = `
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="UTF-8">
                        <title>Report for ${clientName}</title>
                        <style>
                            body { font-family: sans-serif; margin: 2rem; color: #333; }
                            .report-container { max-width: 900px; margin: auto; padding: 20px; border: 1px solid #ddd; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
                            .header { text-align: center; margin-bottom: 20px; }
                            .header h1 { color: #3b82f6; }
                            h2 { margin-top: 20px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
                            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                            .total-row td { font-weight: bold; }
                        </style>
                    </head>
                    <body>
                        <div class="report-container">
                            <div class="header">
                                <h1>Monthly Report</h1>
                                <p>Client: <strong>${clientName}</strong></p>
                                <p>Period: ${startDate} to ${endDate}</p>
                            </div>
                            ${invoices.map(invoice => `
                                <h2>Invoice Date: ${invoice.invoiceDate} (Total: Rs. ${invoice.totalAmount.toFixed(2)})</h2>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Product Name</th>
                                            <th>Qty</th>
                                            <th>Price</th>
                                            <th>Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${invoice.items.map(item => `
                                            <tr>
                                                <td>${item.productName}</td>
                                                <td>${item.quantity}</td>
                                                <td>Rs. ${item.price.toFixed(2)}</td>
                                                <td>Rs. ${item.amount.toFixed(2)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            `).join('')}
                            <div style="text-align: right; font-size: 1.5rem; font-weight: bold; margin-top: 2rem; color: #3b82f6;">
                                Grand Total: Rs. ${invoices.reduce((sum, inv) => sum + inv.totalAmount, 0).toFixed(2)}
                            </div>
                        </div>
                    </body>
                    </html>
                `;

                // Create and download the HTML file
                const blob = new Blob([reportHtml], { type: 'text/html' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `report-${clientName}-${startDate}-to-${endDate}.html`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showMessage("Report Generated", `Monthly report for ${clientName} from ${startDate} to ${endDate} has been generated and downloaded.`);
            } catch (e) {
                console.error("Error generating report: ", e);
                showMessage("Error", "Failed to generate report. Please try again.");
            }
        });

    </script>
</body>
</html>
