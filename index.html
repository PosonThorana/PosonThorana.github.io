import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, serverTimestamp } from 'firebase/firestore';
import { BiPencil, BiTrash, BiDownload, BiPlus } from 'react-icons/bi';

// Define the main App component
const App = () => {
  // State variables for Firebase and authentication status
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);

  // State variables for application data and UI
  const [invoices, setInvoices] = useState([]);
  const [editingInvoiceId, setEditingInvoiceId] = useState(null);
  const [isLoading, setIsLoading] = useState(true);

  // State for the invoice form, with a default item
  const [invoice, setInvoice] = useState({
    clientName: '',
    invoiceDate: '',
    dueDate: '',
    items: [{ description: '', quantity: 1, price: 0 }],
  });

  // Effect hook to initialize Firebase and set up authentication
  useEffect(() => {
    const initFirebase = async () => {
      // Use dynamic import for jsPDF to avoid loading issues.
      // The script is loaded via a CDN in the HTML wrapper.
      // This is a common pattern for client-side libraries.
      // We'll proceed regardless if this fails, as it's only needed for download.
      try {
        await import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
      } catch (error) {
        console.error('Failed to load jsPDF script:', error);
      }
      
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

      // Initialize Firebase app and services
      const firebaseApp = initializeApp(firebaseConfig);
      const firestoreDb = getFirestore(firebaseApp);
      const firebaseAuth = getAuth(firebaseApp);

      setDb(firestoreDb);
      setAuth(firebaseAuth);

      // Authenticate the user with the provided token or anonymously
      const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
      if (token) {
        signInWithCustomToken(firebaseAuth, token)
          .catch((error) => console.error("Firebase custom auth failed:", error));
      } else {
        signInAnonymously(firebaseAuth)
          .catch((error) => console.error("Firebase anonymous auth failed:", error));
      }

      // Listen for auth state changes to get the user ID
      const unsubscribe = onAuthStateChanged(firebaseAuth, (user) => {
        if (user) {
          setUserId(user.uid);
        } else {
          setUserId(null);
        }
        setIsAuthReady(true);
      });

      return () => unsubscribe();
    };

    initFirebase();
  }, []);

  // Effect hook to listen for real-time changes to the invoices collection
  useEffect(() => {
    // Only proceed if Firebase is ready and the user is authenticated
    if (!db || !isAuthReady || !userId) {
      if (isAuthReady) {
        setIsLoading(false);
      }
      return;
    }

    // Define the path to the public invoices collection
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const invoiceCollectionPath = `artifacts/${appId}/public/data/invoices`;
    const q = collection(db, invoiceCollectionPath);
    
    // Set up a real-time listener for the invoices
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const invoicesData = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data(),
        // Convert Firestore Timestamps to JavaScript Date objects
        createdAt: doc.data().createdAt?.toDate()
      }));
      setInvoices(invoicesData);
      setIsLoading(false);
    }, (error) => {
      console.error("Error fetching invoices:", error);
      setIsLoading(false);
    });

    return () => unsubscribe();
  }, [db, isAuthReady, userId]);

  // Handler for changes in the main invoice form fields
  const handleInvoiceChange = (e) => {
    const { name, value } = e.target;
    setInvoice(prev => ({ ...prev, [name]: value }));
  };

  // Handler for changes in individual invoice item fields
  const handleItemChange = (index, e) => {
    const { name, value } = e.target;
    const newItems = [...invoice.items];
    newItems[index][name] = name === 'description' ? value : parseFloat(value) || 0;
    setInvoice(prev => ({ ...prev, items: newItems }));
  };

  // Add a new empty item row to the invoice form
  const handleAddItem = () => {
    setInvoice(prev => ({
      ...prev,
      items: [...prev.items, { description: '', quantity: 1, price: 0 }],
    }));
  };

  // Remove an item row from the invoice form
  const handleRemoveItem = (index) => {
    const newItems = invoice.items.filter((_, i) => i !== index);
    setInvoice(prev => ({ ...prev, items: newItems }));
  };

  // Calculate the total amount for the current invoice form
  const calculateTotal = () => {
    return invoice.items.reduce((total, item) => total + (item.quantity * item.price), 0);
  };

  // Handler for the "Generate & Save" button
  const handleSave = async (e) => {
    e.preventDefault();
    if (!db || !userId) {
      console.error("Firestore not initialized or user not authenticated.");
      return;
    }

    // Basic validation to prevent saving empty invoices
    if (!invoice.clientName || !invoice.invoiceDate || !invoice.dueDate || invoice.items.length === 0) {
        alert("Please fill in all required fields and add at least one item.");
        return;
    }
    
    // Create the invoice object to save
    const invoiceToSave = {
      ...invoice,
      total: calculateTotal(),
      createdAt: serverTimestamp(),
      authorId: userId,
    };
    
    try {
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const collectionRef = collection(db, `artifacts/${appId}/public/data/invoices`);
      
      if (editingInvoiceId) {
        // Update an existing invoice if editingId is set
        const docRef = doc(db, collectionRef.path, editingInvoiceId);
        await setDoc(docRef, invoiceToSave, { merge: true });
        console.log("Invoice updated successfully!");
        setEditingInvoiceId(null);
      } else {
        // Add a new invoice if no editingId is set
        await addDoc(collectionRef, invoiceToSave);
        console.log("Invoice saved successfully!");
      }

      // Reset the form after saving
      setInvoice({
        clientName: '',
        invoiceDate: '',
        dueDate: '',
        items: [{ description: '', quantity: 1, price: 0 }],
      });
    } catch (error) {
      console.error("Error saving invoice:", error);
    }
  };

  // Handler for the "Edit" button on a saved invoice
  const handleEdit = (invoiceToEdit) => {
    setInvoice(invoiceToEdit);
    setEditingInvoiceId(invoiceToEdit.id);
  };

  // Handler for the "Delete" button on a saved invoice
  const handleDelete = async (id) => {
    if (!db || !userId) return;
    try {
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const docRef = doc(db, `artifacts/${appId}/public/data/invoices`, id);
      await deleteDoc(docRef);
      console.log("Invoice deleted successfully!");
    } catch (error) {
      console.error("Error deleting invoice:", error);
    }
  };

  // Handler for the "Download" button on a saved invoice
  const handleDownload = (invoiceToDownload) => {
    // Ensure jsPDF is loaded before attempting to use it
    if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
      console.error("jsPDF is not loaded. Please check the script import.");
      return;
    }
    const doc = new window.jspdf.jsPDF();
    let y = 10;
    const margin = 15;
    const lineSpacing = 10;

    // Set font and add a title
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(22);
    doc.setTextColor(33, 33, 33);
    doc.text('Invoice', margin, y);
    y += lineSpacing * 1.5;

    // Add invoice details
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(12);
    doc.text(`Client: ${invoiceToDownload.clientName}`, margin, y);
    y += lineSpacing;
    doc.text(`Invoice Date: ${invoiceToDownload.invoiceDate}`, margin, y);
    y += lineSpacing;
    doc.text(`Due Date: ${invoiceToDownload.dueDate}`, margin, y);
    y += lineSpacing * 1.5;

    // Add table header
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(14);
    doc.text('Description', margin, y);
    doc.text('Quantity', 100, y, { align: 'center' });
    doc.text('Price', 140, y, { align: 'center' });
    doc.text('Amount', 180, y, { align: 'right' });
    y += lineSpacing * 0.5;
    doc.line(margin, y, 195, y); // Horizontal line for the header
    y += lineSpacing;

    // Add invoice items
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(12);
    invoiceToDownload.items.forEach(item => {
      const amount = item.quantity * item.price;
      doc.text(item.description, margin, y);
      doc.text(item.quantity.toString(), 100, y, { align: 'center' });
      doc.text(`$${item.price.toFixed(2)}`, 140, y, { align: 'center' });
      doc.text(`$${amount.toFixed(2)}`, 180, y, { align: 'right' });
      y += lineSpacing;
    });

    // Add a total section at the bottom
    y += lineSpacing * 2;
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(16);
    doc.text(`Total: $${invoiceToDownload.total.toFixed(2)}`, 180, y, { align: 'right' });
    
    // Save the PDF with a dynamic filename
    doc.save(`invoice_${invoiceToDownload.clientName}.pdf`);
  };

  // Show a loading state while fetching data
  if (!isAuthReady || isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-900 text-white">
        <div className="animate-pulse text-xl font-semibold">Loading...</div>
      </div>
    );
  }

  // Main application UI
  return (
    <div className="flex flex-col min-h-screen bg-gray-900 text-gray-100 font-inter">
      
      {/* Top bar header */}
      <header className="bg-gray-800 shadow-lg p-4 flex justify-between items-center sticky top-0 z-10">
        <h1 className="text-2xl font-bold text-blue-400">Invoice App</h1>
        <div className="bg-gray-700 text-sm p-2 rounded-lg font-mono">
          <span className="font-semibold">User ID:</span> {userId}
        </div>
      </header>

      <main className="container mx-auto p-6 flex flex-col lg:flex-row gap-6 flex-grow">
        
        {/* Invoice Form Section */}
        <div className="lg:w-1/3 w-full bg-gray-800 rounded-xl shadow-lg p-6 h-fit border border-gray-700">
          <h2 className="text-xl font-bold mb-6 text-gray-200">{editingInvoiceId ? 'Edit Invoice' : 'Create New Invoice'}</h2>
          <form onSubmit={handleSave} className="flex flex-col gap-4">
            
            {/* Invoice details inputs */}
            <input
              type="text"
              name="clientName"
              value={invoice.clientName}
              onChange={handleInvoiceChange}
              placeholder="Client Name"
              required
              className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200"
            />
            <div className="flex gap-4">
              <input
                type="date"
                name="invoiceDate"
                value={invoice.invoiceDate}
                onChange={handleInvoiceChange}
                required
                className="w-1/2 p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200"
              />
              <input
                type="date"
                name="dueDate"
                value={invoice.dueDate}
                onChange={handleInvoiceChange}
                required
                className="w-1/2 p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200"
              />
            </div>
            
            {/* Invoice Items Section */}
            <div className="flex flex-col gap-2 p-4 bg-gray-700 rounded-lg">
              <h3 className="text-lg font-semibold mt-0">Invoice Items</h3>
              {invoice.items.map((item, index) => (
                <div key={index} className="flex gap-2 items-center">
                  <input
                    type="text"
                    name="description"
                    value={item.description}
                    onChange={(e) => handleItemChange(index, e)}
                    placeholder="Description"
                    required
                    className="flex-grow p-3 bg-gray-600 border border-gray-500 rounded-lg"
                  />
                  <input
                    type="number"
                    name="quantity"
                    value={item.quantity}
                    onChange={(e) => handleItemChange(index, e)}
                    placeholder="Qty"
                    min="1"
                    className="w-16 p-3 bg-gray-600 border border-gray-500 rounded-lg text-center"
                  />
                  <input
                    type="number"
                    name="price"
                    value={item.price}
                    onChange={(e) => handleItemChange(index, e)}
                    placeholder="Price"
                    step="0.01"
                    className="w-24 p-3 bg-gray-600 border border-gray-500 rounded-lg text-center"
                  />
                  <button type="button" onClick={() => handleRemoveItem(index)} className="p-2 text-red-500 hover:text-red-400 transition duration-200">
                    <BiTrash size={20} />
                  </button>
                </div>
              ))}
              <button
                type="button"
                onClick={handleAddItem}
                className="mt-2 flex items-center justify-center gap-2 p-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition duration-200"
              >
                <BiPlus /> Add Item
              </button>
            </div>
            
            {/* Total Amount and Save Button */}
            <div className="mt-4 text-right">
              <span className="text-lg font-bold text-gray-200">Total: ${calculateTotal().toFixed(2)}</span>
            </div>
            <button
              type="submit"
              className="mt-6 w-full py-3 px-6 bg-green-600 text-white font-bold text-lg rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-300"
            >
              {editingInvoiceId ? 'Update Invoice' : 'Generate & Save'}
            </button>
          </form>
        </div>

        {/* Saved Invoices Section */}
        <div className="lg:w-2/3 w-full bg-gray-800 rounded-xl shadow-lg p-6 border border-gray-700">
          <h2 className="text-xl font-bold mb-6 text-gray-200">Saved Invoices</h2>
          <div className="grid gap-4">
            {invoices.length > 0 ? (
              invoices.map((inv) => (
                <div key={inv.id} className="flex flex-col sm:flex-row justify-between items-center bg-gray-700 p-4 rounded-lg shadow-sm hover:shadow-md transition duration-200 border border-gray-600">
                  <div className="text-center sm:text-left mb-2 sm:mb-0">
                    <h3 className="font-semibold text-lg text-gray-100">{inv.clientName}</h3>
                    <p className="text-gray-400 text-sm">Due: {inv.dueDate}</p>
                    <p className="text-gray-300 text-lg font-bold">Total: ${inv.total.toFixed(2)}</p>
                  </div>
                  <div className="flex gap-2">
                    <button onClick={() => handleEdit(inv)} className="p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200" title="Edit">
                      <BiPencil size={20} />
                    </button>
                    <button onClick={() => handleDelete(inv.id)} className="p-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-200" title="Delete">
                      <BiTrash size={20} />
                    </button>
                    <button onClick={() => handleDownload(inv)} className="p-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200" title="Download">
                      <BiDownload size={20} />
                    </button>
                  </div>
                </div>
              ))
            ) : (
              <p className="text-gray-400 text-center">No invoices saved yet.</p>
            )}
          </div>
        </div>
      </main>
    </div>
  );
};

export default App;
